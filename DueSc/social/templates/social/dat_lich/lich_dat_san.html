{% extends 'base.html' %}
{% load static %}

{% block title %}L·ªãch ƒëƒÉng k√Ω s√¢n b√≥ng - DUE Social{% endblock %}

{% block content %}
<style>
    .schedule-container {
        display: flex;
        justify-content: space-between;
        width: calc(100% - 320px); /* Tr·ª´ ƒëi chi·ªÅu r·ªông c·ªßa sidebar */
        margin: 20px 0;
        padding-right: 20px;
        position: relative;
        margin-left: 320px; /* Ph√π h·ª£p v·ªõi sidebar */
    }

    .schedule-table {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        width: 70%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background-color: white;
        overflow-x: auto;
    }

    .schedule-table h1 {
        font-size: 1.8rem;
        color: #1a73e8;
        margin-top: 20px;
        margin-bottom: 30px;
        text-align: center;
        font-weight: 600;
    }

    .schedule-table h2 {
        text-align: center;
        color: #28a745;
        margin: 10px 0 20px;
        font-weight: 600;
        font-size: 1.6rem;
    }

    .schedule-table table {
        width: 100%;
        border-collapse: collapse;
        display: table;
        min-width: 600px;
    }

    .schedule-table th {
        background-color: #28a745;
        color: white;
        padding: 10px;
        text-align: center;
        white-space: nowrap;
        font-size: 18px;
    }

    .schedule-table td {
        padding: 10px;
        text-align: center;
        border: 1px solid #ddd;
        cursor: pointer;
        white-space: nowrap;
        font-size: 17.5px;
    }

    .schedule-table td:hover {
        background-color: #f0f0f0;
    }

    .selected {
        background-color: #00BB00;
        color: white;
    }

    .booked {
        background-color: #CCCCCC;
        color: white;
        cursor: not-allowed;
    }

    .pending {
        background-color: #FF6633;
        color: white;
        cursor: not-allowed;
    }

    .past-date {
        background-color: #f5f5f5;
        color: #999;
        cursor: not-allowed;
    }

    .book-btn {
        display: block;
        margin: 20px auto;
        padding: 15px 25px;
        background-color: #1a73e8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.2rem;
    }

    .book-btn:hover {
        background-color: #1557b0;
    }

    .status {
        width: 25%;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background-color: white;
        position: absolute;
        right: 20px;
        top: 20px;
        height: calc(100% - 40px);
        overflow-y: auto;
    }

    .status h3 {
        color: #1a73e8;
        margin-bottom: 15px;
        font-size: 1.6rem;
        font-weight:600;
    }

    .status p {
        margin: 5px 0;
        font-size: 19.5px;
    }

    .status .booked {
        color: #28a745;
        background-color: transparent;
    }

    .status .cancelled {
        color: red;
        background-color: transparent;
    }

    .status .pending {
        color: #ffc107;
        background-color: transparent;
    }

    .debug {
        color: red;
        font-weight: bold;
        text-align: center;
    }
</style>
<div class="schedule-container">
    <div class="schedule-table">
        <h1>L·ªãch ƒëƒÉng k√Ω {{ location }}</h1>
        <table class="w-full text-center border-collapse">
            <thead>
                <tr>
                    {% if days %}
                        {% for day in days %}
                            <th class="border p-2">{{ day.name }}<br>{{ day.date }}</th>
                        {% endfor %}
                    {% else %}
                        <th class="debug" colspan="7">Kh√¥ng c√≥ d·ªØ li·ªáu days!</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for row in calendar_data %}
                    <tr>
                        {% for cell in row %}
                            {% if cell.status == 'past' %}
                                <td class="border p-2 past-date" data-date="{{ cell.date }}" data-time="{{ cell.time }}">{{ cell.time }}</td>
                            {% elif cell.status == 'XacNhan' %}
                                <td class="border p-2 booked" data-date="{{ cell.date }}" data-time="{{ cell.time }}">{{ cell.time }}</td>
                            {% elif cell.status == 'ChoDuyet' %}
                                <td class="border p-2 pending" data-date="{{ cell.date }}" data-time="{{ cell.time }}">{{ cell.time }}</td>
                            {% else %}
                                <td class="border p-2" data-date="{{ cell.date }}" data-time="{{ cell.time }}">{{ cell.time }}</td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% empty %}
                    <tr><td class="debug" colspan="7">Kh√¥ng c√≥ d·ªØ li·ªáu l·ªãch!</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <form id="booking-form" method="POST">
            {% csrf_token %}
            <input type="hidden" name="location" value="{{ location }}">
            <input type="hidden" name="name" value="{{ request.user.username|default:'Unknown' }}">
            <input type="hidden" name="email" value="{{ request.user.email|default:'unknown@example.com' }}">
            <input type="hidden" name="student_id" value="">
            <!-- Hidden input ƒë·ªÉ ch·ª©a danh s√°ch l·ªãch -->
            <input type="hidden" name="bookings" id="bookings">
        </form>
        <button class="book-btn" onclick="submitBooking()">ƒê·∫∑t l·ªãch</button>
    </div>

    <div class="status">
        <h3>L·ªãch c·ªßa b·∫°n</h3>
        {% if user_bookings %}
            {% for booking in user_bookings %}
                {% if booking.trang_thai == 'XacNhan' %}
                    <p class="booked">üìÖ ƒê√£ x√°c nh·∫≠n: {{ booking.ngay|date:"d/m/Y" }} - {{ booking.gio_bat_dau|time:"H:i" }} </p>
                {% elif booking.trang_thai == 'ChoDuyet' %}
                    <p class="pending">üìÖ ƒêang ch·ªù duy·ªát: {{ booking.ngay|date:"d/m/Y" }} - {{ booking.gio_bat_dau|time:"H:i" }} </p>
                {% elif booking.trang_thai == 'Huy' %}
                    <p class="cancelled">üìÖ ƒê√£ b·ªã h·ªßy: {{ booking.ngay|date:"d/m/Y" }} - {{ booking.gio_bat_dau|time:"H:i" }} </p>
                {% endif %}
            {% endfor %}
        {% else %}
            <p>B·∫°n ch∆∞a c√≥ l·ªãch ƒë·∫∑t s√¢n n√†o.</p>
        {% endif %}
    </div>
</div>

<script>
    let selectedCells = [];

    // Reset tr·∫°ng th√°i selected khi trang t·∫£i l·∫°i
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.schedule-table td').forEach(cell => {
            cell.classList.remove('selected');
        });
        selectedCells = [];
    });

    // X·ª≠ l√Ω ch·ªçn nhi·ªÅu √¥
    document.querySelectorAll('.schedule-table td').forEach(cell => {
        cell.addEventListener('click', function() {
            // Kh√¥ng cho ph√©p ch·ªçn c√°c √¥ ƒë√£ ƒë·∫∑t ho·∫∑c ng√†y ƒë√£ qua
            if (this.classList.contains('booked') ||
                this.classList.contains('pending') ||
                this.classList.contains('past-date')) {
                return;
            }

            if (this.getAttribute('data-date')) {
                const date = this.getAttribute('data-date');
                const time = this.getAttribute('data-time');
                const booking = { date, time };

                if (this.classList.contains('selected')) {
                    // B·ªè ch·ªçn n·∫øu ƒë√£ ch·ªçn
                    this.classList.remove('selected');
                    selectedCells = selectedCells.filter(b => b.date !== date || b.time !== time);
                } else {
                    // Th√™m v√†o danh s√°ch ch·ªçn
                    this.classList.add('selected');
                    selectedCells.push(booking);
                }
            }
        });
    });

    function submitBooking() {
        if (selectedCells.length > 0) {
            // Chuy·ªÉn danh s√°ch l·ªãch th√†nh JSON
            document.getElementById('bookings').value = JSON.stringify(selectedCells);
            document.getElementById('booking-form').submit();
        } else {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt th·ªùi gian tr∆∞·ªõc khi ƒë·∫∑t l·ªãch!');
        }
    }
</script>
{% endblock %}