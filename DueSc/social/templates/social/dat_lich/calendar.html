{% extends 'base.html' %}
{% load static %}

{% block title %}L·ªãch ƒëƒÉng k√Ω s√¢n b√≥ng - DUE Social{% endblock %}

{% block content %}
<style>
    .schedule-container {
        display: flex;
        justify-content: space-between;
        width: calc(100% - 320px); /* Tr·ª´ ƒëi chi·ªÅu r·ªông c·ªßa sidebar */
        margin: 20px 0;
        padding-right: 20px;
        position: relative;
        margin-left: 320px; /* Ph√π h·ª£p v·ªõi sidebar */
    }

    .schedule-table {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        width: 70%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background-color: white;
        overflow-x: auto;
    }

    .schedule-table h1 {
        font-size: 1.6rem;
        color: #1a73e8;
        margin-top: 20px;
        margin-bottom: 100px;
        text-align: center;
        font-weight: 600;
    }

    .schedule-table h2 {
        text-align: center;
        color: #28a745;
        margin: 10px 0 20px;
        font-weight: 600;
        font-size: 1.2rem;
    }

    .schedule-table table {
        width: 100%;
        border-collapse: collapse;
        display: table;
        min-width: 600px;
    }

    .schedule-table th {
        background-color: #28a745;
        color: white;
        padding: 10px;
        text-align: center;
        white-space: nowrap;
    }

    .schedule-table td {
        padding: 10px;
        text-align: center;
        border: 1px solid #ddd;
        cursor: pointer;
        white-space: nowrap;
    }

    .schedule-table td:hover {
        background-color: #f0f0f0;
    }

    .selected {
        background-color: #1a73e8;
        color: white;
    }

    .book-btn {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        background-color: #1a73e8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .book-btn:hover {
        background-color: #1557b0;
    }

    .status {
        width: 25%;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background-color: white;
        position: absolute;
        right: 20px; /* Th√™m kho·∫£ng c√°ch t·ª´ c·∫°nh ph·∫£i */
        top: 20px; /* Th√™m kho·∫£ng c√°ch t·ª´ ƒë·ªânh */
        height: calc(100% - 40px); /* S·ª≠a l·ªói ch√≠nh t·∫£ v√† ƒë·∫£m b·∫£o chi·ªÅu cao */
        overflow-y: auto; /* Cho ph√©p cu·ªôn n·∫øu n·ªôi dung d√†i */
    }

    .status p {
        margin: 5px 0;
    }

    .status .booked {
        color: #28a745;
    }

    .status .cancelled {
        color: red;
    }

    .debug {
        color: red;
        font-weight: bold;
        text-align: center;
    }
</style>
</style>
<div class="schedule-container">
    <div class="schedule-table">
        <h1>L·ªãch ƒëƒÉng k√Ω {{ location }}</h1>
        <h2>Th√°ng 3</h2>
        <table class="w-full text-center border-collapse">
            <thead>
                <tr>
                    {% if days %}
                        {% for day in days %}
                            <th class="border p-2">{{ day.name }}<br>{{ day.date }}</th>
                        {% endfor %}
                    {% else %}
                        <th class="debug" colspan="6">Kh√¥ng c√≥ d·ªØ li·ªáu days!</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% if times %}
                    {% for time in times %}
                        <tr>
                            {% for day in days %}
                                <td class="border p-2" data-date="2025-03-{{ day.date }}" data-time="{{ time }}">{{ time }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td class="debug" colspan="7">Kh√¥ng c√≥ d·ªØ li·ªáu times!</td></tr>
                {% endif %}
            </tbody>
        </table>
        <form id="booking-form" method="POST" style="display: none;">
            {% csrf_token %}
            <input type="hidden" name="date" id="selected-date">
            <input type="hidden" name="time" id="selected-time">
            <!-- S·ª≠ d·ª•ng gi√° tr·ªã location t·ª´ context -->
            <input type="hidden" name="location" value="{{ location }}">
            <input type="hidden" name="name" value="{{ request.user.username|default:'Unknown' }}">
            <input type="hidden" name="email" value="{{ request.user.email|default:'unknown@example.com' }}">
            <input type="hidden" name="student_id" value="">
        </form>
        <button class="book-btn" onclick="submitBooking()">ƒê·∫∑t l·ªãch</button>
    </div>

    <div class="status">
        {% if bookings %}
            {% for booking in bookings %}
                {% if not booking.is_canceled %}
                    <p class="booked">üìÖ L·ªãch ƒë√£ ƒë·∫∑t: {{ booking.time }} - {{ booking.date|date:"d/m/Y" }}</p>
                {% else %}
                    <p class="cancelled">üìÖ L·ªãch ƒë√£ b·ªã h·ªßy: {{ booking.time }} - {{ booking.date|date:"d/m/Y" }}</p>
                {% endif %}
            {% endfor %}
        {% else %}
            <p class="debug">Kh√¥ng c√≥ d·ªØ li·ªáu bookings!</p>
        {% endif %}
    </div>
</div>

<script>
    let selectedCell = null;

    // Reset tr·∫°ng th√°i selected khi trang t·∫£i l·∫°i
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.schedule-table td').forEach(cell => {
            cell.classList.remove('selected');
        });
        selectedCell = null;
    });

    document.querySelectorAll('.schedule-table td').forEach(cell => {
        cell.addEventListener('click', function() {
            if (this.getAttribute('data-date')) {
                if (selectedCell) selectedCell.classList.remove('selected');
                this.classList.add('selected');
                selectedCell = this;
                document.getElementById('selected-date').value = this.getAttribute('data-date');
                document.getElementById('selected-time').value = this.getAttribute('data-time');
            }
        });
    });

    function submitBooking() {
        if (selectedCell) {
            document.getElementById('booking-form').submit();
        } else {
            alert('Vui l√≤ng ch·ªçn m·ªôt th·ªùi gian tr∆∞·ªõc khi ƒë·∫∑t l·ªãch!');
        }
    }
</script>
{% endblock %}