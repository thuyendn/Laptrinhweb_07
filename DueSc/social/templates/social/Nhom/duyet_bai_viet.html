{% extends 'social/Nhom/chi_tiet_nhom_qtrivien.html' %}
{% load static %}

{% block title %}Phê duyệt bài viết - DUE Social{% endblock %}

{% block post %}
<div class="p-4 mb-4 mt-4">
    <h2 class="text-3xl font-semibold">Phê duyệt bài viết</h2>
</div>

<div class="container p-4 border-2 post border rounded-lg p-4 mb-4 bg-white shadow-md">
    <div class="title text-2xl font-semibold mb-4">Danh sách bài viết chờ duyệt</div>

    {% if danh_sach_bai_viet_cho_duyet %}
    <p>Số lượng bài viết chờ duyệt: {{ danh_sach_bai_viet_cho_duyet|length }}</p>
    {% for bai_viet in danh_sach_bai_viet_cho_duyet %}
    <div class="post-item p-4 mb-4 border rounded-lg shadow-sm" data-post-id="{{ bai_viet.MaBaiViet }}">
        <div class="user-info flex items-center mb-4">
            <img src="{% if bai_viet.MaNguoiDung.avatar %}{{ bai_viet.MaNguoiDung.avatar.url }}{% else %}/static/default-avatar.png{% endif %}" alt="Avatar" class="w-12 h-12 rounded-full mr-4">
            <div>
                <div class="user-name text-lg font-medium">{{ bai_viet.MaNguoiDung.ho_ten }}</div>
                <div class="text-gray-500 text-sm">{{ bai_viet.ThoiGianDang|date:"d/m/Y H:i" }}</div>
            </div>
        </div>
        <div class="post-content mb-4">
            <p>{{ bai_viet.NoiDung }}</p>
        </div>
        <div class="reaction-buttons flex space-x-4 mt-4 justify-end">
            <button class="approve-post-btn bg-green-500 text-white px-4 py-1 rounded-lg hover:bg-green-600 transition duration-300 font-semibold" data-post-id="{{ bai_viet.MaBaiViet }}">Duyệt</button>
            <button class="reject-post-btn bg-red-400 text-white px-4 py-1 rounded-lg hover:bg-red-500 transition duration-300 font-semibold" data-post-id="{{ bai_viet.MaBaiViet }}">Từ chối</button>
        </div>
    </div>
    {% empty %}
    <p class="text-center text-gray-500">Không có bài viết nào đang chờ duyệt.</p>
    {% endfor %}
    {% else %}
    <p>Debug: danh_sach_bai_viet_cho_duyet is empty or not passed to template.</p>
    {% endif %}
</div>

<script>
document.querySelectorAll('.approve-post-btn').forEach(button => {
    button.addEventListener('click', function() {
        const postId = this.dataset.postId;
        if (confirm('Bạn có chắc muốn duyệt bài viết này?')) {
            fetch(`/duyet-bai-viet-xac-nhan/{{ nhom.ma_nhom }}/${postId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi duyệt bài viết.');
            });
        }
    });
});

document.querySelectorAll('.reject-post-btn').forEach(button => {
    button.addEventListener('click', function() {
        const postId = this.dataset.postId;
        if (confirm('Bạn có chắc muốn từ chối bài viết này?')) {
            fetch(`/tu-choi-bai-viet/{{ nhom.ma_nhom }}/${postId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi từ chối bài viết.');
            });
        }
    });
});
</script>
{% endblock %}