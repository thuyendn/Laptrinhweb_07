{% extends 'social/group.html' %}
{% load static %}

{% block title %}Chi tiết nhóm - DUE Social{% endblock %}

{% block content_body %}
   <div class="shadow-md">
       <!-- Ảnh bìa -->
       <!-- Ảnh bìa -->
        <div class="relative">
            <img id="groupAvatar" src="{% if nhom.avatar %}{{ nhom.avatar.url }}{% else %}{% static 'image/Nhom/nhom1.png' %}{% endif %}" alt="Ảnh nhóm" class="w-full h-48 object-cover">
            {% if is_admin %}
            <div class="absolute bottom-2 right-2">
                <button id="changeAvatarBtn" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-300 text-sm font-semibold">
                    Thay đổi ảnh
                </button>
                <input type="file" id="avatarUpload" class="hidden" accept="image/*">
                <div id="avatarPreview" class="hidden mt-2">
                    <img src="#" alt="Preview" class="w-32 h-32 object-cover rounded-lg">
                </div>
            </div>
            {% endif %}
        </div>

       <!-- Nội dung nhóm -->
       <div class="p-4">
           <div class="flex justify-between items-start">
               <div>
                   <h2 class="text-xl font-semibold text-gray-900">{{ nhom.ten_nhom }}</h2>
                   <div class="text-sm text-gray-500 flex items-center space-x-1">
                       <i class="fas fa-lock"></i>
                       <span>Nhóm {% if nhom.trang_thai_nhom == 'Riêng tư' %}Riêng Tư{% else %}Công khai{% endif %}</span>
                   </div>
               </div>
               <!-- Nút mở modal Mời -->
               <button id="openInviteModal" class="bg-green-300 text-gray-800 px-3 py-1 rounded-lg hover:bg-green-400 transition duration-300 text-sm font-semibold">
                   + Mời
               </button>

               <!-- Modal mời thành viên -->
               <div id="inviteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                   <div class="bg-white rounded-[40px] w-[500px] max-w-full p-6 shadow-lg relative">
                       <!-- Nút đóng -->
                       <button id="closeInviteModal" class="absolute top-4 right-4 text-2xl font-bold">×</button>
                       <!-- Tiêu đề -->
                       <h2 class="text-center text-xl font-bold mb-4">Mời thành viên tham gia nhóm này</h2>
                       <!-- Khung tìm kiếm và gợi ý -->
                       <div class="mb-4 relative">
                           <input type="text" id="searchInput" placeholder="Tìm kiếm người dùng..." class="w-full border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring focus:ring-blue-300">
                           <div id="suggestionList" class="absolute w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-40 overflow-y-auto shadow-lg hidden"></div>
                           <p id="noResults" class="text-gray-500 text-center mt-2 hidden">Không tìm thấy người dùng phù hợp.</p>
                       </div>
                       <!-- Thông tin người dùng được chọn -->
                       <div id="selectedUser" class="bg-gray-100 p-2 rounded-lg mb-4 hidden">
                           <span id="selectedUserName"></span>
                           <button id="clearSelection" class="text-red-500 ml-2">Xóa</button>
                       </div>
                       <!-- Nút hành động -->
                       <div class="flex justify-end gap-4 mt-6">
                           <button id="closeInviteModal2" class="bg-gray-300 text-white font-semibold px-4 py-2 rounded-lg">Huỷ</button>
                           <button id="sendInvite" class="bg-green-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-600">Gửi lời mời</button>
                       </div>
                   </div>
               </div>
           </div>
           <!-- Nút xoá nhóm -->
            <div class="mt-3">
                {% if is_admin %}
                    <button id="deleteBtn" class="bg-red-400 text-white px-4 py-1 rounded-lg hover:bg-red-500 transition duration-300 font-semibold">
                        Xoá nhóm
                    </button>
                {% endif %}
                <!-- Modal xác nhận xoá -->
                <div id="deleteModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
                    <div id="modalContent" class="bg-white p-6 rounded shadow-lg">
                        <p class="text-xl mb-4">Bạn có chắc chắn muốn xóa nhóm <strong>{{ nhom.ten_nhom }}</strong> không?</p>
                        <div class="flex justify-end space-x-4">
                            <button id="confirmDelete" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Xoá</button>
                            <button id="cancelDelete" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Huỷ</button>
                        </div>
                    </div>
                </div>
            </div>
       </div>
       <!-- Menu -->
       <div class="border-t px-4 py-2 grid grid-cols-2 md:grid-cols-4 text-sm font-medium text-center text-gray-600">
           <a href="{% url 'chi_tiet_nhom_qtrivien' ma_nhom=nhom.id %}" class="py-2 hover:text-blue-600 cursor-pointer">Bảng tin nhóm</a>
           <a href="{% url 'duyet_thanh_vien' ma_nhom=nhom.id %}" class="py-2 hover:text-blue-600 cursor-pointer">Phê duyệt thành viên</a>
           <a href="{% url 'duyet_bai_viet' ma_nhom=nhom.id %}" class="py-2 hover:text-blue-600 cursor-pointer">Phê duyệt bài viết</a>
           <a href="{% url 'thanh_vien_nhom' ma_nhom=nhom.id %}" class="py-2 hover:text-blue-600 cursor-pointer">Thành viên của nhóm</a>
       </div>
   </div>
   <!-- Phần tạo bài viết -->
<div class="bg-white rounded-lg shadow-md p-4 mb-4 mt-6">
    <div class="flex items-center space-x-3 mb-3">
        <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden">
            {% if nguoi_dung.avatar %}
                <img src="{% static 'image/Nhom/avt.png' %}" alt="Avatar" class="w-full h-full object-cover">

            {% else %}
                <i class="fas fa-user text-gray-500"></i>
            {% endif %}
        </div>
        <input type="text" placeholder="Hãy đăng bài viết!" class="bg-gray-100 rounded-full py-3 px-4 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" id="createPostInput" readonly>
    </div>
    <div class="border-t border-gray-200 pt-3 flex justify-around">
        <button class="flex items-center text-gray-600 hover:bg-gray-100 rounded-md px-3 py-2 post-type-video">
            <i class="fas fa-video text-red-500 mr-2"></i>
            <span>Video</span>
        </button>
        <button class="flex items-center text-gray-600 hover:bg-gray-100 rounded-md px-3 py-2 post-type-image">
            <i class="fas fa-image text-green-500 mr-2"></i>
            <span>Hình ảnh</span>
        </button>
        <button class="flex items-center text-gray-600 hover:bg-gray-100 rounded-md px-3 py-2 post-type-file">
            <i class="fas fa-file-alt text-yellow-500 mr-2"></i>
            <span>Tệp tài liệu</span>
        </button>
        <button class="flex items-center text-gray-600 hover:bg-gray-100 rounded-md px-3 py-2 post-type-poll">
            <i class="fas fa-poll text-blue-500 mr-2"></i>
            <span>Thăm dò ý kiến</span>
        </button>
    </div>
</div>

<!-- Modal tạo bài viết -->
<div id="createPostModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-lg mx-4 overflow-hidden">
        <!-- Header -->
        <div class="flex justify-between items-center p-4 border-b">
            <h2 class="text-xl font-semibold text-center w-full modal-title">Tạo bài viết</h2>
            <button id="closeModal" class="text-gray-500 hover:text-gray-700 absolute right-4">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Body -->
        <div class="p-4">
            <!-- User info -->
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden">
                    {% if nguoi_dung.avatar %}
                        <img src="{% static 'image/avt.png' %}" alt="Avatar" class="w-full h-full object-cover">
                    {% else %}
                        <i class="fas fa-user text-gray-500"></i>
                    {% endif %}
                </div>
                <div>
                    <h4 class="font-semibold">{{ nguoi_dung.ho_ten }}</h4>
                </div>
            </div>

            <!-- Text area -->
            <textarea
                id="postContent"
                class="w-full border-0 focus:ring-0 text-lg resize-none min-h-[150px] outline-none"
                placeholder="Bạn đang nghĩ gì thế?"
            ></textarea>

            <!-- Content containers for different post types -->
            <div id="imageContainer" class="hidden">
                <div class="mt-4 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                    <input type="file" id="imageUpload" class="hidden" accept="image/*">
                    <label for="imageUpload" class="cursor-pointer block">
                        <div class="flex flex-col items-center justify-center py-6">
                            <i class="fas fa-plus text-gray-400 mb-2"></i>
                            <span class="text-gray-700 font-medium">Thêm ảnh</span>
                            <span class="text-gray-500 text-sm">Hoặc kéo và thả</span>
                        </div>
                    </label>
                    <div id="imagePreview" class="mt-4 hidden">
                        <img src="#" alt="Preview" class="max-h-64 mx-auto">
                    </div>
                </div>
            </div>

            <div id="videoContainer" class="hidden">
                <div class="mt-4 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                    <input type="file" id="videoUpload" class="hidden" accept="video/*">
                    <label for="videoUpload" class="cursor-pointer block">
                        <div class="flex flex-col items-center justify-center py-6">
                            <i class="fas fa-video text-red-500 mb-2 text-2xl"></i>
                            <span class="text-gray-700 font-medium">Thêm video</span>
                            <span class="text-gray-500 text-sm">Hoặc kéo và thả</span>
                        </div>
                    </label>
                    <div id="videoPreview" class="mt-4 hidden">
                        <video controls class="max-h-64 mx-auto"></video>
                    </div>
                </div>
            </div>

            <div id="fileContainer" class="hidden">
                <div class="mt-4 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                    <input type="file" id="fileUpload" class="hidden">
                    <label for="fileUpload" class="cursor-pointer block">
                        <div class="flex flex-col items-center justify-center py-6">
                            <i class="fas fa-file-alt text-yellow-500 mb-2 text-2xl"></i>
                            <span class="text-gray-700 font-medium">Thêm tệp tài liệu</span>
                            <span class="text-gray-500 text-sm">Nhấp vào đây hoặc kéo và thả</span>
                            <span class="text-gray-500 text-xs mt-2">Hỗ trợ các định dạng: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT</span>
                        </div>
                    </label>
                    <div id="filePreview" class="mt-4 hidden">
                        <div class="bg-gray-100 p-3 rounded-lg flex items-center">
                            <i class="fas fa-file-alt text-yellow-500 mr-3 text-xl"></i>
                            <span class="file-name text-gray-700 truncate flex-1"></span>
                            <button type="button" id="removeFile" class="text-gray-500 hover:text-red-500">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pollContainer" class="hidden">
                <div class="mt-4">
                    <h3 class="font-medium mb-3">Thêm cuộc thăm dò ý kiến</h3>
                    <div id="pollOptionsContainer">
                        <div class="poll-option flex items-center mb-2">
                            <input type="text" class="flex-grow px-4 py-2 border rounded-md"
                                   placeholder="Lựa chọn 1" name="poll_option_1">
                            <button type="button" class="remove-option ml-2 text-gray-500 hover:text-red-500 invisible">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="poll-option flex items-center mb-2">
                            <input type="text" class="flex-grow px-4 py-2 border rounded-md"
                                   placeholder="Lựa chọn 2" name="poll_option_2">
                            <button type="button" class="remove-option ml-2 text-gray-500 hover:text-red-500 invisible">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="addPollOption" class="mt-2 text-blue-600 hover:text-blue-800 flex items-center">
                        <i class="fas fa-plus mr-2"></i> Thêm lựa chọn
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="px-4 pb-4">
            <!-- Add to post section -->
            <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium">Thêm vào bài viết của bạn</p>
                    <div class="flex space-x-4">
                        <button class="text-red-500 post-type-btn" data-type="video">
                            <i class="fas fa-video text-xl"></i>
                        </button>
                        <button class="text-green-500 post-type-btn" data-type="image">
                            <i class="fas fa-image text-xl"></i>
                        </button>
                        <button class="text-yellow-500 post-type-btn" data-type="file">
                            <i class="fas fa-file-alt text-xl"></i>
                        </button>
                        <button class="text-blue-500 post-type-btn" data-type="poll">
                            <i class="fas fa-poll text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Post button -->
            <button id="submitPost" class="w-full py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                Đăng
            </button>
        </div>
    </div>
</div>

<!-- Template for comment item -->
<template id="comment-template">
    <div class="comment-item flex items-start mb-3">
        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center mr-2 flex-shrink-0 overflow-hidden">
            <i class="fas fa-user text-gray-500 text-xs"></i>
        </div>
        <div class="bg-gray-100 rounded-lg px-3 py-2 flex-grow">
            <div class="flex justify-between items-center">
                <h5 class="font-semibold text-sm comment-username"></h5>
                <span class="text-xs text-gray-500 comment-time"></span>
            </div>
            <p class="text-sm comment-content"></p>
        </div>
    </div>
</template>
<!-- Thêm toast vào cuối block content -->
<div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white p-4 rounded-lg shadow-lg hidden" role="alert">
    Nhóm đã được xóa thành công!
</div>
{% endblock %}

{% block post %}
   <!-- Danh sách bài viết -->
   <div id="posts-list" data-group-id="{{ nhom.id }}">
       {% for post in posts_with_details %}
       {% if post.post.trang_thai == 'DaDuyet' %}
       <div class="post border rounded-lg p-4 mb-4 bg-white shadow-md" data-post-id="{{ post.post.id }}">
           <!-- Avatar và thông tin người đăng -->
           <div class="flex items-center mb-2">
                {% if post.post.ma_nguoi_dung.avatar %}
                    <img src="{{ post.post.ma_nguoi_dung.avatar.url }}" alt="avatar" class="w-10 h-10 rounded-full mr-2">
                {% else %}
                    <img src="{% static 'image/avt.png' %}" alt="avatar" class="w-10 h-10 rounded-full mr-2">
                {% endif %}

               <div>
                   <p class="font-bold">{{ post.post.ma_nguoi_dung.ho_ten }}</p>
                   <p class="text-gray-500 text-sm">{{ post.post.thoi_gian_dang|date:"d/m/Y H:i" }}</p>
                   <p class="text-gray-500 text-sm">Trong nhóm: {{ post.post.ma_nhom.ten_nhom }}</p>
               </div>
           </div>
           <!-- Nội dung bài viết -->
           <div class="relative">
               <p class="post-content overflow-hidden max-h-24 transition-all duration-300 ease-in-out">
                   {{ post.post.noi_dung }}
               </p>
               {% if post.word_count > 50 %}
               <button class="text-blue-500 mt-1 text-sm toggle-content-btn">Xem thêm</button>
               {% endif %}
           </div>
           <!-- Nút thích và bình luận -->
           <div class="flex justify-between mt-3">
               <button class="like-btn text-gray-500 hover:underline" data-post-id="{{ post.post.id }}" onclick="likePost(this)">
                   <i class="fas fa-heart mr-2 {% if post.has_liked %}text-red-500{% else %}text-gray-500{% endif %}" id="heart-icon-{{ post.post.id }}"></i>
                   <span class="like-count">{{ post.like_count }}</span>
                   <span class="like-text">{% if post.has_liked %}Đã thích{% else %}Thích{% endif %}</span>
               </button>
               <button class="text-gray-500 hover:underline" onclick="toggleCommentBox(this)">
                   <i class="fas fa-comment text-gray-500 mr-2"></i>
                   <span>Bình luận</span>
               </button>
           </div>
           <!-- Phần bình luận -->
           <div class="comment-box hidden mt-4">
               <!-- Bình luận đã có -->
               <div class="existing-comments space-y-3">
                   {% for comment in post.post.binh_luan.all %}
                    <div class="flex items-start">
                        {% if comment.ma_nguoi_dung.avatar %}
                            <img src="{{ comment.ma_nguoi_dung.avatar.url }}" alt="avatar" class="w-8 h-8 rounded-full mr-2">
                        {% else %}
                            <img src="{% static 'image/avt.png' %}" alt="avatar" class="w-8 h-8 rounded-full mr-2">
                        {% endif %}

                       <div>
                           <p class="font-semibold">{{ comment.ma_nguoi_dung.ho_ten }}</p>
                           <p class="bg-gray-100 rounded-lg p-2">{{ comment.noi_dung }}</p>
                       </div>
                   </div>
                   {% endfor %}
               </div>
               <!-- Gửi bình luận mới -->
               <div class="flex items-center mt-4">
                    {% if nguoi_dung.avatar %}
                        <img src="{{ nguoi_dung.avatar.url }}" alt="avatar" class="w-8 h-8 rounded-full mr-2">
                    {% else %}
                        <img src="{% static 'image/avt.png' %}" alt="avatar" class="w-8 h-8 rounded-full mr-2">
                    {% endif %}
                   <input type="text" id="commentInput-{{ post.post.id }}" placeholder="Viết bình luận..." class="border rounded-lg p-2 w-full">
                   <button class="bg-blue-500 text-white px-3 py-2 rounded-lg ml-2" onclick="submitComment(this, {{ post.post.id }})">Gửi</button>
               </div>
           </div>
       </div>
       {% endif %}
       {% empty %}
       <p class="text-center text-gray-500 mt-4">Chưa có bài viết nào trong nhóm này.</p>
       {% endfor %}
   </div>

   <style>
       .post-content {
           overflow: hidden;
           max-height: 6rem;
           transition: max-height 0.3s ease-in-out;
           white-space: pre-wrap;
       }
       .toggle-content-btn {
           color: #3b82f6;
           margin-top: 0.25rem;
           font-size: 0.875rem;
       }
       .toggle-content-btn:hover {
           text-decoration: underline;
       }

       /* File display styles */
       .file-attachment {
           margin-top: 1rem;
           padding: 1rem;
           background-color: #f9fafb;
           border: 1px solid #e5e7eb;
           border-radius: 0.5rem;
           display: flex;
           align-items: center;
       }

       .file-icon {
           font-size: 2rem;
           color: #f59e0b;
           margin-right: 1rem;
       }

       .file-info {
           flex: 1;
       }

       .file-name {
           font-weight: 500;
           color: #111827;
           margin-bottom: 0.25rem;
       }

       .file-type {
           font-size: 0.875rem;
           color: #6b7280;
       }

       .file-download {
           background-color: #2563eb;
           color: white;
           padding: 0.5rem 1rem;
           border-radius: 0.375rem;
           font-weight: 500;
           display: flex;
           align-items: center;
           transition: background-color 0.2s;
       }

       .file-download:hover {
           background-color: #1d4ed8;
       }

       .file-download i {
           margin-right: 0.5rem;
       }

       /* Poll styles */
       .poll-container {
           margin-top: 1rem;
           background-color: #f9fafb;
           border: 1px solid #e5e7eb;
           border-radius: 0.5rem;
           padding: 1rem;
       }

       .poll-title {
           font-weight: 600;
           margin-bottom: 1rem;
           color: #111827;
       }

       .poll-option {
           margin-bottom: 0.75rem;
       }

       .poll-option-button {
           width: 100%;
           text-align: left;
           padding: 0.75rem 1rem;
           background-color: #ffffff;
           border: 1px solid #d1d5db;
           border-radius: 0.375rem;
           font-weight: 500;
           transition: background-color 0.2s;
       }

       .poll-option-button:hover {
           background-color: #f3f4f6;
       }

       .poll-option-button.voted {
           background-color: #dbeafe;
           border-color: #93c5fd;
       }

       .poll-results {
           margin-top: 0.5rem;
       }

       .poll-bar-container {
           height: 0.5rem;
           background-color: #e5e7eb;
           border-radius: 9999px;
           overflow: hidden;
           margin-bottom: 0.25rem;
       }

       .poll-bar {
           height: 100%;
           background-color: #3b82f6;
           border-radius: 9999px;
       }

       .poll-stats {
           display: flex;
           justify-content: space-between;
           font-size: 0.75rem;
           color: #6b7280;
       }

       .poll-votes {
           font-weight: 500;
       }

       .poll-percentage {
           font-weight: 500;
       }
   </style>


<script>
document.addEventListener('DOMContentLoaded', function() {
// Xử lý thay đổi ảnh đại diện nhóm
const changeAvatarBtn = document.getElementById('changeAvatarBtn');
const avatarUpload = document.getElementById('avatarUpload');
const avatarPreview = document.getElementById('avatarPreview');
const groupAvatar = document.getElementById('groupAvatar');

if (changeAvatarBtn && avatarUpload) {
    // Mở input file khi nhấn nút "Thay đổi ảnh"
    changeAvatarBtn.addEventListener('click', function() {
        avatarUpload.click();
    });

    // Xử lý khi chọn file
    avatarUpload.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();

            reader.onload = function(e) {
                avatarPreview.querySelector('img').src = e.target.result;
                avatarPreview.classList.remove('hidden');
            };

            reader.readAsDataURL(this.files[0]);

            // Tự động gửi ảnh lên server sau khi chọn
            uploadAvatar(this.files[0]);
        }
    });

    // Hàm gửi ảnh lên server
    function uploadAvatar(file) {
        const csrftoken = getCookie('csrftoken');
        if (!csrftoken) {
            alert('Không tìm thấy CSRF token. Vui lòng đăng nhập lại hoặc tải lại trang.');
            return;
        }

        const formData = new FormData();
        formData.append('avatar', file);
        formData.append('group_id', {{ nhom.id }});

        fetch('/update-group-avatar/{{ nhom.id }}/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Cập nhật ảnh đại diện trên giao diện
                groupAvatar.src = data.avatar_url;
                avatarPreview.classList.add('hidden');
                alert('Ảnh đại diện nhóm đã được cập nhật thành công!');
            } else {
                alert(data.message || 'Có lỗi xảy ra khi cập nhật ảnh đại diện.');
                avatarPreview.classList.add('hidden');
            }
        })
        .catch(error => {
            console.error('Error uploading avatar:', error);
            alert('Có lỗi xảy ra khi cập nhật ảnh đại diện: ' + error.message);
            avatarPreview.classList.add('hidden');
        });
    }
}
// Thêm sự kiện cho các nút post type bên ngoài modal
    const postTypeVideoBtn = document.querySelector('.post-type-video');
    const postTypeImageBtn = document.querySelector('.post-type-image');
    const postTypeFileBtn = document.querySelector('.post-type-file');
    const postTypePollBtn = document.querySelector('.post-type-poll');

    if (postTypeVideoBtn) {
        postTypeVideoBtn.addEventListener('click', function() {
            createPostModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            postContent.focus();
            setPostType('video');
        });
    }

    if (postTypeImageBtn) {
        postTypeImageBtn.addEventListener('click', function() {
            createPostModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            postContent.focus();
            setPostType('image');
        });
    }

    if (postTypeFileBtn) {
        postTypeFileBtn.addEventListener('click', function() {
            createPostModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            postContent.focus();
            setPostType('file');
        });
    }

    if (postTypePollBtn) {
        postTypePollBtn.addEventListener('click', function() {
            createPostModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            postContent.focus();
            setPostType('poll');
        });
    }
    // Elements for post creation
    const createPostInput = document.getElementById('createPostInput');
    const createPostModal = document.getElementById('createPostModal');
    const closeModal = document.getElementById('closeModal');
    const postContent = document.getElementById('postContent');
    const submitPost = document.getElementById('submitPost');

    // Toggle comment box function
    window.toggleCommentBox = function(button) {
        const commentBox = button.closest('.post').querySelector('.comment-box');
        if (commentBox) {
            commentBox.classList.toggle('hidden');
        }
    };

    // Submit comment function
    window.submitComment = function(button, postId) {
        const post = button.closest('.post');
        const commentInput = post.querySelector(`#commentInput-${postId}`);
        const content = commentInput.value.trim();

        if (!content) return;

        // Get CSRF token
        const csrftoken = getCookie('csrftoken');

        // Create form data
        const formData = new FormData();
        formData.append('noi_dung', content);

        // Hiển thị nút đang xử lý
        const submitButton = button;
        const originalText = submitButton.textContent;
        submitButton.textContent = 'Đang gửi...';
        submitButton.disabled = true;

        // Send request to the correct backend endpoint
        fetch(`/them-binh-luan/${postId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Clear input
                commentInput.value = '';

                // Lấy thông tin người dùng hiện tại nếu không có từ server
                const username = data.ho_ten || '{{ nguoi_dung.ho_ten }}';
                const avatarUrl = data.avatar_url || "{% if nguoi_dung.avatar %}{{ nguoi_dung.avatar.url }}{% else %}{% static 'image/avt.png' %}{% endif %}";

                // Add comment to DOM
                const commentsContainer = post.querySelector('.existing-comments');
                const commentHTML = `
                    <div class="flex items-start">
                        <img src="${avatarUrl}" alt="avatar" class="w-8 h-8 rounded-full mr-2">
                        <div>
                            <p class="font-semibold">${username}</p>
                            <p class="bg-gray-100 rounded-lg p-2">${content}</p>
                        </div>
                    </div>
                `;
                commentsContainer.insertAdjacentHTML('beforeend', commentHTML);
            } else {
                alert(data.message || 'Có lỗi xảy ra khi gửi bình luận.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi gửi bình luận: ' + error.message);
        })
        .finally(() => {
            // Khôi phục nút submit
            submitButton.textContent = originalText;
            submitButton.disabled = false;
        });
    };

    // Like post function
    window.likePost = function(button) {
        const postId = button.getAttribute('data-post-id');
        const heartIcon = button.querySelector(`#heart-icon-${postId}`);
        const likeCount = button.querySelector('.like-count');
        const likeText = button.querySelector('.like-text');

        // Get CSRF token
        const csrftoken = getCookie('csrftoken');

        // Send request
        fetch(`/like-post/${postId}/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update like count
                likeCount.textContent = data.count;

                // Toggle heart icon and text
                if (data.liked) {
                    heartIcon.classList.add('text-red-500');
                    heartIcon.classList.remove('text-gray-500');
                    likeText.textContent = 'Đã thích';
                } else {
                    heartIcon.classList.remove('text-red-500');
                    heartIcon.classList.add('text-gray-500');
                    likeText.textContent = 'Thích';
                }
            } else {
                alert(data.error || 'Có lỗi xảy ra khi thích bài viết.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi thích bài viết.');
        });
    };

    // Process post content to display files and polls
    // Process post content to display polls
    function processPostContent() {
    document.querySelectorAll('.post-content').forEach(post => {
        let content = post.textContent;
        const pollMatch = content.match(/\[POLL\](.*?)\[\/POLL\]/);
        if (pollMatch) {
            const pollQuestion = pollMatch[1] || 'Thăm dò ý kiến';
            const postId = post.closest('.post-item').getAttribute('data-post-id');

            // Lấy dữ liệu thăm dò từ API
            fetch(`/get-poll/${postId}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const pollContainer = document.createElement('div');
                    pollContainer.classList.add('poll-container', 'mt-4', 'p-4', 'bg-gray-100', 'rounded-lg');

                    const questionEl = document.createElement('h4');
                    questionEl.classList.add('font-semibold', 'mb-3');
                    questionEl.textContent = pollQuestion;
                    pollContainer.appendChild(questionEl);

                    data.options.forEach(opt => {
                        const percentage = data.total_votes > 0
                            ? Math.round((opt.vote_count / data.total_votes) * 100)
                            : 0;

                        const optionEl = document.createElement('div');
                        optionEl.classList.add('poll-option', 'mb-2');

                        const button = document.createElement('button');
                        button.classList.add('poll-option-button', 'w-full', 'text-left', 'p-2', 'rounded-md', 'border', 'hover:bg-gray-200');
                        if (opt.voted) button.classList.add('voted');
                        button.setAttribute('data-post-id', postId);
                        button.setAttribute('data-option-id', opt.option_id);
                        button.onclick = function() { votePoll(this); };
                        button.textContent = opt.option_text;
                        optionEl.appendChild(button);

                        const pollBar = document.createElement('div');
                        pollBar.classList.add('poll-bar', 'h-2', 'bg-blue-500', 'rounded', 'mt-1');
                        pollBar.style.width = `${percentage}%`;
                        optionEl.appendChild(pollBar);

                        const voteInfo = document.createElement('div');
                        voteInfo.classList.add('text-sm', 'text-gray-600', 'mt-1');
                        voteInfo.innerHTML = `<span class="poll-votes">${opt.vote_count} phiếu</span> - <span class="poll-percentage">${percentage}%</span>`;
                        optionEl.appendChild(voteInfo);

                        pollContainer.appendChild(optionEl);
                    });

                    const totalVotesEl = document.createElement('div');
                    totalVotesEl.classList.add('text-sm', 'text-gray-500', 'mt-3');
                    totalVotesEl.textContent = `Tổng số: ${data.total_votes} phiếu`;
                    pollContainer.appendChild(totalVotesEl);

                    post.parentNode.insertBefore(pollContainer, post.nextSibling);
                }
            })
            .catch(error => console.error('Lỗi khi tải dữ liệu thăm dò:', error));
        }
    });
}

    window.votePoll = function(button) {
    // Lấy postId và optionId từ data attributes
    const postId = button.getAttribute('data-post-id');
    const optionId = button.getAttribute('data-option-id');
    const pollContainer = button.closest('.poll-container');

    // Kiểm tra dữ liệu đầu vào
    if (!postId || !optionId) {
        console.error('postId hoặc optionId không hợp lệ:', { postId, optionId });
        alert('Dữ liệu thăm dò không hợp lệ. Vui lòng thử lại.');
        return;
    }

    // Get CSRF token
    const csrftoken = getCookie('csrftoken');
    if (!csrftoken) {
        alert('Không tìm thấy CSRF token. Vui lòng đăng nhập lại.');
        return;
    }

    // Disable button to prevent multiple votes
    button.disabled = true;

    fetch(`/vote-poll/${postId}/${optionId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Lỗi mạng: ' + response.status + ' ' + response.statusText);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Cập nhật tổng số phiếu
            const totalVotesEl = pollContainer.querySelector('.text-sm.text-gray-500');
            totalVotesEl.textContent = `Tổng số: ${data.total_votes} phiếu`;

            // Cập nhật tất cả các lựa chọn
            const options = pollContainer.querySelectorAll('.poll-option');
            options.forEach(option => {
                const optionButton = option.querySelector('.poll-option-button');
                const currentOptionId = optionButton.getAttribute('data-option-id');
                const pollBar = option.querySelector('.poll-bar');
                const pollVotes = option.querySelector('.poll-votes');
                const pollPercentage = option.querySelector('.poll-percentage');

                const votes = data.options[currentOptionId] || 0;
                const percentage = data.total_votes > 0
                    ? Math.round((votes / data.total_votes) * 100)
                    : 0;

                pollBar.style.width = `${percentage}%`;
                pollVotes.textContent = `${votes} phiếu`;
                pollPercentage.textContent = `${percentage}%`;

                // Đánh dấu lựa chọn đã được vote
                if (currentOptionId == data.voted_option_id) {
                    optionButton.classList.add('voted');
                }
            });
        } else {
            alert(data.error || 'Có lỗi xảy ra khi bình chọn. Vui lòng thử lại.');
        }
    })
    .catch(error => {
        console.error('Lỗi bình chọn:', error);
        alert('Có lỗi xảy ra khi bình chọn: ' + error.message);
    })
    .finally(() => {
        button.disabled = false;
    });
};

    // Vote on poll function
    window.votePoll = function(postId, optionId, button) {
        console.log('Bình chọn thăm dò:', postId, optionId);

        // Get CSRF token
        const csrftoken = getCookie('csrftoken');

        // Send request
        fetch(`/vote-poll/${postId}/${optionId}/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Lỗi mạng: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Kết quả bình chọn:', data);

            if (data.success) {
                const pollContainer = button.closest('.poll-container');
                const totalVotesEl = pollContainer.querySelector('.text-sm.text-gray-500');

                // Update total votes
                totalVotesEl.textContent = `Tổng số: ${data.total_votes} phiếu`;

                // Update all options
                const options = pollContainer.querySelectorAll('.poll-option');
                options.forEach(option => {
                    const optionButton = option.querySelector('.poll-option-button');
                    const optionId = optionButton.getAttribute('data-option-id');
                    const pollBar = option.querySelector('.poll-bar');
                    const pollVotes = option.querySelector('.poll-votes');
                    const pollPercentage = option.querySelector('.poll-percentage');

                    // Get votes for this option
                    const votes = data.options[optionId] || 0;

                    // Calculate percentage
                    const percentage = data.total_votes > 0
                        ? Math.round((votes / data.total_votes) * 100)
                        : 0;

                    // Update UI
                    pollBar.style.width = `${percentage}%`;
                    pollVotes.textContent = `${votes} phiếu`;
                    pollPercentage.textContent = `${percentage}%`;

                    // Mark as voted if this is the selected option
                    if (optionId == optionId) {
                        optionButton.classList.add('voted');
                    } else {
                        optionButton.classList.remove('voted');
                    }
                });
            } else {
                alert(data.error || 'Có lỗi xảy ra khi bình chọn.');
            }
        })
        .catch(error => {
            console.error('Lỗi bình chọn:', error);
            alert('Có lỗi xảy ra khi bình chọn. Vui lòng thử lại sau.');
        });
    };

    // Toggle content expansion
    document.querySelectorAll('.toggle-content-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const postContent = this.previousElementSibling;
            if (postContent.style.maxHeight === 'none') {
                postContent.style.maxHeight = '6rem';
                this.textContent = 'Xem thêm';
            } else {
                postContent.style.maxHeight = 'none';
                this.textContent = 'Thu gọn';
            }
        });
    });

    // Elements for different post types
    const postTypeBtns = document.querySelectorAll('.post-type-btn');
    const imageContainer = document.getElementById('imageContainer');
    const videoContainer = document.getElementById('videoContainer');
    const fileContainer = document.getElementById('fileContainer');
    const pollContainer = document.getElementById('pollContainer');

    // Current post type
    let currentPostType = 'text';

    // Open modal when clicking on the input
    if (createPostInput) {
        createPostInput.addEventListener('click', function() {
            createPostModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
            postContent.focus();

            // Reset post type
            resetPostType();
        });
    }

    // Close modal when clicking on the close button
    if (closeModal) {
        closeModal.addEventListener('click', function() {
            createPostModal.classList.add('hidden');
            document.body.style.overflow = ''; // Allow scrolling again
            resetForm();
        });
    }

    // Close modal when clicking outside
    createPostModal.addEventListener('click', function(e) {
        if (e.target === createPostModal) {
            createPostModal.classList.add('hidden');
            document.body.style.overflow = '';
            resetForm();
        }
    });

    // Handle post type buttons
    postTypeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            setPostType(type);
        });
    });

    // Set post type
    function setPostType(type) {
        // Hide all containers
        imageContainer.classList.add('hidden');
        videoContainer.classList.add('hidden');
        fileContainer.classList.add('hidden');
        pollContainer.classList.add('hidden');

        // Show the selected container
        currentPostType = type;

        if (type === 'image') {
            imageContainer.classList.remove('hidden');
        } else if (type === 'video') {
            videoContainer.classList.remove('hidden');
        } else if (type === 'file') {
            fileContainer.classList.remove('hidden');
        } else if (type === 'poll') {
            pollContainer.classList.remove('hidden');
        }
    }

    // Reset post type
    function resetPostType() {
        currentPostType = 'text';
        imageContainer.classList.add('hidden');
        videoContainer.classList.add('hidden');
        fileContainer.classList.add('hidden');
        pollContainer.classList.add('hidden');
    }

    // Reset form
    function resetForm() {
        postContent.value = '';
        resetPostType();

        // Reset file inputs
        document.getElementById('imageUpload').value = '';
        document.getElementById('videoUpload').value = '';
        document.getElementById('fileUpload').value = '';

        // Reset previews
        document.getElementById('imagePreview').classList.add('hidden');
        document.getElementById('videoPreview').classList.add('hidden');
        document.getElementById('filePreview').classList.add('hidden');

        // Reset poll options
        const pollOptionsContainer = document.getElementById('pollOptionsContainer');
        pollOptionsContainer.innerHTML = `
            <div class="poll-option flex items-center mb-2">
                <input type="text" class="flex-grow px-4 py-2 border rounded-md"
                       placeholder="Lựa chọn 1" name="poll_option_1">
                <button type="button" class="remove-option ml-2 text-gray-500 hover:text-red-500 invisible">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="poll-option flex items-center mb-2">
                <input type="text" class="flex-grow px-4 py-2 border rounded-md"
                       placeholder="Lựa chọn 2" name="poll_option_2">
                <button type="button" class="remove-option ml-2 text-gray-500 hover:text-red-500 invisible">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    }

    // Handle file uploads
    const imageUpload = document.getElementById('imageUpload');
    const imagePreview = document.getElementById('imagePreview');

    if (imageUpload) {
        imageUpload.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    imagePreview.querySelector('img').src = e.target.result;
                    imagePreview.classList.remove('hidden');
                }

                reader.readAsDataURL(this.files[0]);
            }
        });
    }

    const videoUpload = document.getElementById('videoUpload');
    const videoPreview = document.getElementById('videoPreview');

    if (videoUpload) {
        videoUpload.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const video = videoPreview.querySelector('video');
                video.src = URL.createObjectURL(this.files[0]);
                videoPreview.classList.remove('hidden');
            }
        });
    }

    const fileUpload = document.getElementById('fileUpload');
    const filePreview = document.getElementById('filePreview');

    if (fileUpload) {
        fileUpload.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                filePreview.querySelector('.file-name').textContent = this.files[0].name;
                filePreview.classList.remove('hidden');
            }
        });
    }

    // Handle remove file button
    const removeFileBtn = document.getElementById('removeFile');
    if (removeFileBtn) {
        removeFileBtn.addEventListener('click', function() {
            document.getElementById('fileUpload').value = '';
            document.getElementById('filePreview').classList.add('hidden');
        });
    }

    // Add poll option
    const addPollOption = document.getElementById('addPollOption');

    if (addPollOption) {
        addPollOption.addEventListener('click', function() {
            const pollOptionsContainer = document.getElementById('pollOptionsContainer');
            const optionCount = pollOptionsContainer.querySelectorAll('.poll-option').length + 1;

            if (optionCount <= 10) {
                const newOption = document.createElement('div');
                newOption.className = 'poll-option flex items-center mb-2';
                newOption.innerHTML = `
                    <input type="text" class="flex-grow px-4 py-2 border rounded-md"
                           placeholder="Lựa chọn ${optionCount}" name="poll_option_${optionCount}">
                    <button type="button" class="remove-option ml-2 text-gray-500 hover:text-red-500">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                pollOptionsContainer.appendChild(newOption);

                // Add event listener to remove button
                newOption.querySelector('.remove-option').addEventListener('click', function() {
                    newOption.remove();
                    // Renumber the remaining options
                    renumberPollOptions();
                });
            }

            // Update the add button state
            if (optionCount >= 10) {
                addPollOption.disabled = true;
                addPollOption.classList.add('opacity-50');
            }
        });
    }

    // Renumber poll options
    function renumberPollOptions() {
        const pollOptions = document.querySelectorAll('.poll-option input');
        pollOptions.forEach((option, index) => {
            option.placeholder = `Lựa chọn ${index + 1}`;
            option.name = `poll_option_${index + 1}`;
        });

        // Re-enable the add button if we're below 10 options
        if (pollOptions.length < 10) {
            addPollOption.disabled = false;
            addPollOption.classList.remove('opacity-50');
        }
    }

    // Submit post
    if (submitPost) {
        submitPost.addEventListener('click', function() {
            // Validate form
            if (!postContent.value.trim() && currentPostType !== 'poll') {
                alert('Vui lòng nhập nội dung bài viết!');
                return;
            }

            // Kiểm tra file nếu cần
            if (currentPostType === 'image') {
                const imageFile = document.getElementById('imageUpload').files[0];
                if (!imageFile) {
                    alert('Vui lòng chọn một hình ảnh!');
                    return;
                }
            } else if (currentPostType === 'video') {
                const videoFile = document.getElementById('videoUpload').files[0];
                if (!videoFile) {
                    alert('Vui lòng chọn một video!');
                    return;
                }
            } else if (currentPostType === 'file') {
                const file = document.getElementById('fileUpload').files[0];
                if (!file) {
                    alert('Vui lòng chọn một tệp!');
                    return;
                }
            } else if (currentPostType === 'poll') {
                const pollOptions = document.querySelectorAll('#pollOptionsContainer input');
                let validOptions = 0;

                pollOptions.forEach(option => {
                    if (option.value.trim()) {
                        validOptions++;
                    }
                });

                if (validOptions < 2) {
                    alert('Thăm dò ý kiến cần ít nhất 2 lựa chọn!');
                    return;
                }
            }

            // Get CSRF token
            const csrftoken = getCookie('csrftoken');
            if (!csrftoken) {
                alert('Không tìm thấy CSRF token. Vui lòng tải lại trang và thử lại.');
                return;
            }

            // Hiển thị nút đang xử lý
            submitPost.textContent = 'Đang xử lý...';
            submitPost.disabled = true;

            // Tạo form data
            const formData = new FormData();
            formData.append('content', postContent.value.trim());
            formData.append('post_type', currentPostType);
            formData.append('group_id', {{ nhom.id }});

            // Thêm dữ liệu cho các loại bài đăng khác nhau
            if (currentPostType === 'poll') {
                const pollOptions = document.querySelectorAll('#pollOptionsContainer input');
                let optionIndex = 1;

                pollOptions.forEach((option) => {
                    if (option.value.trim()) {
                        formData.append(`option_${optionIndex}`, option.value.trim());
                        optionIndex++;
                    }
                });
            }

            // Thêm file nếu có
            if (currentPostType === 'image') {
                const imageFile = document.getElementById('imageUpload').files[0];
                formData.append('image', imageFile);
            } else if (currentPostType === 'video') {
                const videoFile = document.getElementById('videoUpload').files[0];
                formData.append('video', videoFile);
            } else if (currentPostType === 'file') {
                const file = document.getElementById('fileUpload').files[0];
                formData.append('file', file);
            }

            // Gửi dữ liệu lên server - KHÔNG đặt Content-Type header để browser tự xác định
            fetch('/post-article/{{ nhom.id }}/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    // Close modal and reset form
                    createPostModal.classList.add('hidden');
                    document.body.style.overflow = '';
                    resetForm();
                    alert('Bài viết đã được gửi và đang chờ duyệt!');
                    // Tải lại trang hiện tại
                    window.location.reload();
                } else {
                    alert(data.error || 'Có lỗi xảy ra khi đăng bài viết.');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Có lỗi xảy ra khi đăng bài viết: ' + error.message);
            })
            .finally(() => {
                // Khôi phục nút submit
                submitPost.textContent = 'Đăng';
                submitPost.disabled = false;
            });
        });
    }

    // Xóa nhóm
    const deleteBtn = document.getElementById('deleteBtn');
    const deleteModal = document.getElementById('deleteModal');
    const confirmDelete = document.getElementById('confirmDelete');
    const cancelDelete = document.getElementById('cancelDelete');
    const toast = document.getElementById('toast');

    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            deleteModal.classList.remove('hidden');
        });
    }

    if (cancelDelete) {
        cancelDelete.addEventListener('click', function() {
            deleteModal.classList.add('hidden');
        });
    }

    if (confirmDelete) {
        confirmDelete.addEventListener('click', function() {
            confirmDelete.textContent = 'Đang xóa...';
            confirmDelete.disabled = true;

            const csrftoken = getCookie('csrftoken');
            if (!csrftoken) {
                alert('Không tìm thấy CSRF token. Vui lòng đăng nhập lại hoặc tải lại trang.');
                confirmDelete.textContent = 'Xoá';
                confirmDelete.disabled = false;
                return;
            }

            const groupId = '{{ nhom.id }}';
            fetch(`/delete-group/${groupId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    deleteModal.classList.add('hidden');
                    toast.style.display = 'block';
                    setTimeout(() => {
                        toast.style.display = 'none';
                        window.location.href = '/groups/';
                    }, 3000);
                } else {
                    alert(data.message || 'Có lỗi xảy ra khi xóa nhóm.');
                    deleteModal.classList.add('hidden');
                }
            })
            .catch(error => {
                console.error('Lỗi:', error);
                alert('Có lỗi xảy ra khi xóa nhóm: ' + error.message);
                deleteModal.classList.add('hidden');
            })
            .finally(() => {
                confirmDelete.textContent = 'Xoá';
                confirmDelete.disabled = false;
            });
        });
    }

    if (deleteModal) {
        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) {
                deleteModal.classList.add('hidden');
            }
        });
    }

    // Mời thành viên
    const openInviteModal = document.getElementById('openInviteModal');
    const inviteModal = document.getElementById('inviteModal');
    const closeInviteModal = document.getElementById('closeInviteModal');
    const closeInviteModal2 = document.getElementById('closeInviteModal2');
    const searchInput = document.getElementById('searchInput');
    const suggestionList = document.getElementById('suggestionList');
    const noResults = document.getElementById('noResults');
    const selectedUser = document.getElementById('selectedUser');
    const selectedUserName = document.getElementById('selectedUserName');
    const clearSelection = document.getElementById('clearSelection');
    const sendInvite = document.getElementById('sendInvite');

    let selectedUserId = null;

    // Mở modal mời
    if (openInviteModal) {
        openInviteModal.addEventListener('click', function() {
            inviteModal.classList.remove('hidden');
            searchInput.focus();
            resetInviteForm();
        });
    }

    // Đóng modal
    function closeInviteModalFunc() {
        inviteModal.classList.add('hidden');
        resetInviteForm();
    }

    if (closeInviteModal) {
        closeInviteModal.addEventListener('click', closeInviteModalFunc);
    }

    if (closeInviteModal2) {
        closeInviteModal2.addEventListener('click', closeInviteModalFunc);
    }

    if (inviteModal) {
        inviteModal.addEventListener('click', function(e) {
            if (e.target === inviteModal) {
                closeInviteModalFunc();
            }
        });
    }

    // Xử lý tìm kiếm người dùng
    if (searchInput) {
        searchInput.addEventListener('input', debounce(function() {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                suggestionList.classList.add('hidden');
                noResults.classList.add('hidden');
                return;
            }

            fetch(`/search-users/?q=${encodeURIComponent(query)}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                suggestionList.innerHTML = '';
                if (data && data.users && Array.isArray(data.users) && data.users.length > 0) {
                    data.users.forEach(user => {
                        const div = document.createElement('div');
                        div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                        div.textContent = user.ho_ten;
                        div.dataset.userId = user.id;
                        div.addEventListener('click', () => selectUser(user.id, user.ho_ten));
                        suggestionList.appendChild(div);
                    });
                    suggestionList.classList.remove('hidden');
                    noResults.classList.add('hidden');
                } else {
                    suggestionList.classList.add('hidden');
                    noResults.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error searching users:', error);
                suggestionList.classList.add('hidden');
                noResults.classList.add('hidden');
            });
        }, 300));
    }

    // Chọn người dùng
    function selectUser(userId, userName) {
        selectedUserId = userId;
        selectedUserName.textContent = userName;
        selectedUser.classList.remove('hidden');
        suggestionList.classList.add('hidden');
        searchInput.value = '';
        noResults.classList.add('hidden');
    }

    // Xóa lựa chọn
    if (clearSelection) {
        clearSelection.addEventListener('click', function() {
            selectedUserId = null;
            selectedUser.classList.add('hidden');
            searchInput.value = '';
            suggestionList.classList.add('hidden');
            noResults.classList.add('hidden');
        });
    }

    // Gửi lời mời
    if (sendInvite) {
        sendInvite.addEventListener('click', function() {
            if (!selectedUserId) {
                alert('Vui lòng chọn một người dùng để mời!');
                return;
            }

            const csrftoken = getCookie('csrftoken');
            if (!csrftoken) {
                alert('Không tìm thấy CSRF token. Vui lòng đăng nhập lại hoặc tải lại trang.');
                return;
            }

            sendInvite.textContent = 'Đang gửi...';
            sendInvite.disabled = true;

            fetch(`/invite-to-group/{{ nhom.id }}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ user_id: selectedUserId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Lời mời đã được gửi thành công!');
                    closeInviteModalFunc();
                } else {
                    alert(data.message || 'Có lỗi xảy ra khi gửi lời mời.');
                }
            })
            .catch(error => {
                console.error('Error sending invite:', error);
                alert('Có lỗi xảy ra khi gửi lời mời.');
            })
            .finally(() => {
                sendInvite.textContent = 'Gửi lời mời';
                sendInvite.disabled = false;
            });
        });
    }

    // Reset form mời
    function resetInviteForm() {
        selectedUserId = null;
        selectedUser.classList.add('hidden');
        searchInput.value = '';
        suggestionList.classList.add('hidden');
        noResults.classList.add('hidden');
    }

    // Hàm debounce
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Hàm lấy CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Process post content when page loads
    processPostContent();
});
</script>
{% endblock %}
