{% extends 'base.html' %}
{% load static %}

{% block title %}Nhóm - DUE Social{% endblock %}

{% block show_search_bar %}
<!-- Hide the search bar on the left -->
{% endblock %}

{% block content_wrapper_class %}
<!-- Remove the left margin since the search bar is hidden -->
{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
    #main-content-area {
        margin-left: 450px; /* Dịch sang phải 20px */
    }
</style>
<div class="flex">
    <!-- Main content area -->
    <div class="flex-1 max-w-3xl mx-auto py-6 px-4" id="main-content-area">
        <!-- Default content - Group Feed -->
        <div id="default-content">
            <h2 class="text-xl font-semibold mb-4">Bảng tin nhóm</h2>
            {% for post in posts %}
            <div class="mb-6 bg-white rounded-lg shadow post-item" data-post-id="{{ post.id }}">
                <div class="p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center space-x-3">
                            <img src="{% if post.ma_nhom.avatar %}{{ post.ma_nhom.avatar.url }}{% else %}{% static 'image/avt.png' %}{% endif %}" alt="Group avatar" class="w-12 h-12 rounded-full">
                            <div>
                                <a href="{% url 'admin_group_detail' post.ma_nhom.id %}" class="font-semibold text-blue-600 hover:underline">{{ post.ma_nhom.ten_nhom }}</a>
                                <p class="font-medium">{{ post.ma_nguoi_dung.ho_ten }}</p>
                                <p class="text-sm text-gray-500">{{ post.thoi_gian_dang|date:"d/m/Y H:i" }}</p>
                            </div>
                        </div>
                        {% if post.ma_nguoi_dung == nguoi_dung %}
                        <button class="text-gray-500 hover:bg-gray-100 p-1 rounded-full delete-post-btn" data-post-id="{{ post.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <p class="mb-2">{{ post.noi_dung }}</p>
                        {% if post.image %}
                        <img src="{{ post.image.url }}" alt="Post image" class="mt-3 rounded-lg max-h-96 w-auto mx-auto">
                        {% endif %}
                        {% if post.video %}
                        <video controls src="{{ post.video.url }}" class="mt-3 rounded-lg max-h-96 w-auto mx-auto"></video>
                        {% endif %}
                        {% if post.file %}
                        <a href="{% url 'download_file' file_path=post.file.name %}" class="mt-3 inline-block bg-gray-100 p-3 rounded-lg flex items-center">
                            <i class="fas fa-file-alt text-yellow-500 mr-3 text-xl"></i>
                            <span class="text-blue-600 hover:underline">{{ post.file.name|slice:"post_files/"|cut:"post_files/" }}</span>
                        </a>
                        {% endif %}
                        {% if post.post_type == 'poll' %}
                        <div class="mt-3 poll-container" data-post-id="{{ post.id }}">
                            <h4 class="font-medium mb-2">Thăm dò ý kiến:</h4>
                            {% for option in post.poll_options.all %}
                            <div class="mb-2">
                                <div class="flex items-center">
                                    <div class="vote-option-container flex items-center w-full">
                                        <input type="checkbox" class="vote-checkbox mr-2"
                                               data-option-id="{{ option.id }}" data-post-id="{{ post.id }}"
                                               {% if option.id in voted_options %}checked{% endif %}>
                                        <label class="flex-grow bg-gray-100 hover:bg-gray-200 rounded-md px-3 py-2 text-left">
                                            {{ option.text }}
                                        </label>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    <span class="vote-count">{{ option.votes }}</span> phiếu
                                    {% if option.votes > 0 %}
                                    <button class="voters-btn text-blue-500 ml-2" data-option-id="{{ option.id }}">Xem danh sách</button>
                                    {% endif %}
                                </div>
                                <div class="voters-list hidden text-xs text-gray-600 mt-1" data-option-id="{{ option.id }}">
                                    <!-- Danh sách người bầu chọn sẽ được load qua AJAX -->
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="border-t border-gray-200 pt-3 flex justify-between">
                        <button class="flex items-center text-gray-600 hover:bg-gray-100 rounded-md px-4 py-2 like-btn {% if post.id in liked_posts %}text-red-500{% endif %}" data-post-id="{{ post.id }}">
                            <i class="fas fa-heart mr-2"></i>
                            <span class="like-count">{{ post.cam_xuc.count }}</span>
                        </button>
                        <button class="flex items-center text-gray-600 hover:bg-gray-100 rounded-md px-4 py-2 comment-btn" data-post-id="{{ post.id }}">
                            <i class="fas fa-comment text-gray-500 mr-2"></i>
                            <span class="comment-count">{{ post.binh_luan.count }}</span>
                        </button>
                    </div>
                    <!-- Comment section (hidden by default) -->
                    <div class="comment-section mt-3 hidden" id="comment-section-{{ post.id }}">
                        <div class="border-t border-gray-200 pt-3">
                            <div class="comments-container" id="comments-container-{{ post.id }}">
                                <!-- Comments will be loaded here -->
                            </div>
                            <div class="mt-3 flex">
                                <div class="w-8 h-8 rounded-full overflow-hidden mr-2 flex-shrink-0">
                                    <img src="{% if nguoi_dung.avatar %}{{ nguoi_dung.avatar.url }}{% else %}{% static 'image/avt.png' %}{% endif %}" alt="User avatar" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-grow relative">
                                    <input type="text" class="comment-input bg-gray-100 rounded-full py-2 px-4 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Viết bình luận..." data-post-id="{{ post.id }}">
                                    <button class="absolute right-3 top-2 text-blue-500 send-comment-btn" data-post-id="{{ post.id }}">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <i class="fas fa-file-alt text-gray-400 text-5xl mb-4"></i>
                <p class="text-xl text-gray-600">Chưa có bài viết nào</p>
            </div>
            {% endfor %}
        </div>

        <!-- Pending Groups View (Hidden by default) -->
        <div id="pending-groups-view" class="hidden">
            <h2 class="text-xl font-semibold mb-4">Nhóm cần phê duyệt</h2>
            {% for group in pending_groups %}
            <div class="bg-white rounded-lg shadow mb-6 overflow-hidden">
                <div class="p-4">
                    <div class="flex items-center mb-3">
                        <div class="h-12 w-12 rounded-full overflow-hidden mr-4">
                            <img src="{% if group.avatar %}{{ group.avatar.url }}{% else %}{% static 'image/avt.png' %}{% endif %}" alt="Group avatar" class="h-full w-full object-cover">
                        </div>
                        <div>
                            <h3 class="font-medium text-lg">{{ group.ten_nhom }}</h3>
                        </div>
                    </div>
                    <p class="text-gray-700 mb-3">{{ group.mo_ta|truncatewords:30 }}</p>
                    <div class="text-right">
                        <a href="{% url 'admin_group_detail' group.id %}" class="text-blue-600 hover:underline">Xem chi tiết</a>
                    </div>
                </div>
                <div class="flex border-t border-gray-100">
                    <button onclick="approveGroup({{ group.id }})" class="flex-1 py-2 text-green-600 hover:bg-gray-50 transition-colors font-medium">
                        Xác nhận
                    </button>
                    <button onclick="rejectGroup({{ group.id }})" class="flex-1 py-2 text-red-500 hover:bg-gray-50 transition-colors font-medium border-l border-gray-100">
                        Từ chối
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <p class="text-gray-500">Không có nhóm nào cần phê duyệt.</p>
            </div>
            {% endfor %}
        </div>

        <!-- All Groups View (Hidden by default) -->
        <div id="all-groups-view" class="hidden">
            <h2 class="text-xl font-semibold text-base">Các nhóm</h2>
            {% for group in groups %}
            <div class="bg-white rounded-lg shadow mb-4 overflow-hidden">
                <div class="p-4 flex items-center">
                    <div class="h-12 w-12 rounded-full overflow-hidden mr-4">
                        <img src="{% if group.avatar %}{{ group.avatar.url }}{% else %}{% static 'image/avt.png' %}{% endif %}" alt="Group avatar" class="h-full w-full object-cover">
                    </div>
                    <div class="flex-1">
                        <h3 class="font-medium text-lg">{{ group.ten_nhom }}</h3>
                    </div>
                </div>
                <div class="flex border-t border-gray-100">
                    <a href="{% url 'admin_group_detail' group.id %}" class="flex-1 text-center py-2 text-blue-600 hover:bg-gray-50 transition-colors">
                        Xem chi tiết
                    </a>
                    <button onclick="confirmDeleteGroup({{ group.id }})" class="flex-1 text-center py-2 text-red-500 hover:bg-gray-50 transition-colors border-l border-gray-100">
                        Xoá nhóm
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <p class="text-gray-500">Không có nhóm nào.</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Right sidebar -->
    {% block group_sidebar %}
    <div class="w-80 p-6 bg-white border-l border-gray-200">
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4">Nhóm</h2>
            <div class="relative mb-4">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="search-group" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tìm kiếm nhóm theo tên">
            </div>
            <!-- Khu vực hiển thị kết quả tìm kiếm -->
            <div id="search-results" class="space-y-3 mt-2 max-h-48 overflow-y-auto">
                <!-- Kết quả tìm kiếm sẽ được hiển thị ở đây -->
            </div>
            <button id="create-group-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg mb-4 mt-4">
                Tạo nhóm mới
            </button>
        </div>

        <div class="mb-6">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-base">Phê duyệt nhóm</h3>
                <a href="#" class="text-blue-600 text-sm hover:underline" id="view-pending-groups">Xem thêm</a>
            </div>
            <div class="space-y-3">
                {% for group in pending_groups|slice:":6" %}
                <div class="flex items-center">
                    <div class="h-10 w-10 rounded-full overflow-hidden mr-3">
                        <img src="{% if group.avatar %}{{ group.avatar.url }}{% else %}{% static 'image/avt.png' %}{% endif %}" alt="Group avatar" class="h-full w-full object-cover">
                    </div>
                    <button onclick="openGroupApprovalModal({{ group.id }}, '{{ group.ten_nhom }}', '{{ group.mo_ta|escapejs }}')" class="font-medium hover:underline">{{ group.ten_nhom }}</button>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm">Không có nhóm nào cần phê duyệt.</p>
                {% endfor %}
            </div>
        </div>

        <div>
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-base">Các nhóm</h3>
                <a href="#" class="text-blue-600 text-sm hover:underline" id="view-all-groups">Xem thêm</a>
            </div>
            <div class="space-y-3">
                {% for group in groups|slice:":6" %}
                <div class="flex items-center">
                    <div class="h-10 w-10 rounded-full overflow-hidden mr-3">
                        <img src="{% if group.avatar %}{{ group.avatar.url }}{% else %}{% static 'image/avt.png' %}{% endif %}" alt="Group avatar" class="h-full w-full object-cover">
                    </div>
                    <a href="{% url 'admin_group_detail' group.id %}" class="font-medium hover:underline">{{ group.ten_nhom }}</a>
                </div>
                {% empty %}
                <p class="text-gray-500 text-sm">Không có nhóm nào.</p>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endblock %}
</div>

<!-- Modal for creating a new group -->
<div id="create-group-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
        <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
        </button>
        <h2 class="text-xl font-bold mb-4">Tạo nhóm mới</h2>
        <form id="create-group-form" method="POST" action="{% url 'create_group_admin' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-4">
                <label for="ten_nhom" class="block text-sm font-medium text-gray-700">Tên nhóm</label>
                <input type="text" name="ten_nhom" id="ten_nhom" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div class="mb-4">
                <label for="mo_ta" class="block text-sm font-medium text-gray-700">Mô tả</label>
                <textarea name="mo_ta" id="mo_ta" rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            <div class="mb-4">
                <label for="avatar" class="block text-sm font-medium text-gray-700">Ảnh đại diện</label>
                <input type="file" name="avatar" id="avatar" accept="image/png,image/jpeg,image/jpg" class="w-full py-2">
            </div>
            <div class="mb-4">
                <label for="cover_image" class="block text-sm font-medium text-gray-700">Ảnh bìa</label>
                <input type="file" name="cover_image" id="cover_image" accept="image/png,image/jpeg,image/jpg" class="w-full py-2">
            </div>
            <div class="flex justify-end">
                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md">
                    Tạo nhóm
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal for group approval -->
<div id="group-approval-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
        <button id="close-approval-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
        </button>
        <h2 class="text-xl font-bold mb-4" id="group-name"></h2>
        <p class="text-gray-700 mb-4" id="group-description"></p>
        <div class="flex justify-end space-x-3">
            <button id="approve-group-btn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">
                Xác nhận
            </button>
            <button id="reject-group-btn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">
                Từ chối
            </button>
        </div>
    </div>
</div>

<!-- Template for comment item -->
<template id="comment-template">
    <div class="comment-item flex items-start mb-3">
        <div class="w-8 h-8 rounded-full overflow-hidden mr-2 flex-shrink-0">
            <img src="{% static 'image/avt.png' %}" alt="User avatar" class="w-full h-full object-cover">
        </div>
        <div class="bg-gray-100 rounded-lg px-3 py-2 flex-grow">
            <div class="flex justify-between items-center">
                <h5 class="font-semibold text-sm comment-username"></h5>
                <span class="text-xs text-gray-500 comment-time"></span>
            </div>
            <p class="text-sm comment-content"></p>
        </div>
    </div>
</template>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const defaultContent = document.getElementById('default-content');
        const allGroupsView = document.getElementById('all-groups-view');
        const pendingGroupsView = document.getElementById('pending-groups-view');
        const viewAllGroupsLink = document.getElementById('view-all-groups');
        const viewPendingGroupsLink = document.getElementById('view-pending-groups');
        const mainContentArea = document.getElementById('main-content-area');
        const createGroupBtn = document.getElementById('create-group-btn');
        const createGroupModal = document.getElementById('create-group-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const createGroupForm = document.getElementById('create-group-form');
        const searchGroupInput = document.getElementById('search-group');
        const searchResults = document.getElementById('search-results');

        // Group approval modal elements
        const groupApprovalModal = document.getElementById('group-approval-modal');
        const closeApprovalModalBtn = document.getElementById('close-approval-modal-btn');
        const groupNameElement = document.getElementById('group-name');
        const groupDescriptionElement = document.getElementById('group-description');
        const approveGroupBtn = document.getElementById('approve-group-btn');
        const rejectGroupBtn = document.getElementById('reject-group-btn');
        let currentGroupId = null;

        // Handle query parameter to show correct view on page load
        const urlParams = new URLSearchParams(window.location.search);
        const view = urlParams.get('view');
        if (view === 'all' && defaultContent && allGroupsView && pendingGroupsView && mainContentArea) {
            defaultContent.classList.add('hidden');
            pendingGroupsView.classList.add('hidden');
            allGroupsView.classList.remove('hidden');
            createBackButton();
        } else if (view === 'pending' && defaultContent && allGroupsView && pendingGroupsView && mainContentArea) {
            defaultContent.classList.add('hidden');
            allGroupsView.classList.add('hidden');
            pendingGroupsView.classList.remove('hidden');
            createBackButton();
        }

        // View all groups
        viewAllGroupsLink.addEventListener('click', function(e) {
            e.preventDefault();
            defaultContent.classList.add('hidden');
            pendingGroupsView.classList.add('hidden');
            allGroupsView.classList.remove('hidden');
            createBackButton();
        });

        // View pending groups
        viewPendingGroupsLink.addEventListener('click', function(e) {
            e.preventDefault();
            defaultContent.classList.add('hidden');
            allGroupsView.classList.add('hidden');
            pendingGroupsView.classList.remove('hidden');
            createBackButton();
        });

        // Create back button
        function createBackButton() {
            if (document.getElementById('back-button')) return;

            const backButton = document.createElement('button');
            backButton.id = 'back-button';
            backButton.className = 'mb-4 flex items-center text-blue-600 hover:text-blue-800';
            backButton.innerHTML = '<i class="fas fa-arrow-left mr-2"></i> Quay lại';
            backButton.addEventListener('click', function() {
                allGroupsView.classList.add('hidden');
                pendingGroupsView.classList.add('hidden');
                defaultContent.classList.remove('hidden');
                backButton.remove();
            });

            mainContentArea.insertBefore(backButton, mainContentArea.firstChild);
        }

        // Search groups by name using AJAX
        searchGroupInput.addEventListener('input', function() {
            const query = this.value.trim();
            if (query.length >= 2) {
                fetch(`{% url 'admin_search_groups' %}?q=${encodeURIComponent(query)}`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Yêu cầu tìm kiếm thất bại: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        let html = '';
                        if (data.groups.length > 0) {
                            data.groups.forEach(group => {
                                if (group.id) {
                                    const avatarUrl = group.avatar ? group.avatar : '{% static "image/avt.png" %}';
                                    const groupDetailUrl = `/GV/nhom_admin/${group.id}/`;
                                    html += `
                                        <div class="flex items-center">
                                            <a href="${groupDetailUrl}" class="flex items-center w-full hover:bg-gray-100 p-1 rounded">
                                                <div class="h-10 w-10 rounded-full overflow-hidden mr-3">
                                                    <img src="${avatarUrl}" alt="Group avatar" class="h-full w-full object-cover">
                                                </div>
                                                <span class="font-medium">${group.ten_nhom}</span>
                                            </a>
                                        </div>
                                    `;
                                } else {
                                    html += '<p class="text-red-500 text-sm">Lỗi: ID nhóm không hợp lệ.</p>';
                                }
                            });
                        } else {
                            html = '<p class="text-gray-500 text-sm">Không tìm thấy nhóm nào.</p>';
                        }
                        searchResults.innerHTML = html;
                    } else {
                        searchResults.innerHTML = '<p class="text-red-500 text-sm">Lỗi: ' + (data.message || 'Không thể tìm kiếm.') + '</p>';
                    }
                })
                .catch(error => {
                    searchResults.innerHTML = '<p class="text-red-500 text-sm">Đã xảy ra lỗi khi tìm kiếm: ' + error.message + '</p>';
                });
            } else {
                searchResults.innerHTML = '';
            }
        });

        // Like post
        const likeBtns = document.querySelectorAll('.like-btn');
        likeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const postId = this.getAttribute('data-post-id');
                fetch(`/like-post/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    this.querySelector('.like-count').textContent = data.SoLuongCamXuc;
                    if (data.liked) {
                        this.classList.add('text-red-500');
                    } else {
                        this.classList.remove('text-red-500');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Đã xảy ra lỗi khi thích bài viết.');
                });
            });
        });

        // Delete post
        const deletePostBtns = document.querySelectorAll('.delete-post-btn');
        deletePostBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const postId = this.getAttribute('data-post-id');
                if (confirm('Bạn có chắc muốn xóa bài viết này?')) {
                    fetch(`/delete-post/${postId}/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.querySelector(`.post-item[data-post-id="${postId}"]`).remove();
                            alert(data.message);
                        } else {
                            alert(data.error || 'Có lỗi xảy ra khi xóa bài viết.');
                        }
                    })
                    .catch(error => {
                        alert('Có lỗi xảy ra khi xóa bài viết: ' + error.message);
                    });
                }
            });
        });

        // Comment section
        const commentBtns = document.querySelectorAll('.comment-btn');
        commentBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const postId = this.getAttribute('data-post-id');
                const commentSection = document.getElementById(`comment-section-${postId}`);
                if (commentSection.classList.contains('hidden')) {
                    commentSection.classList.remove('hidden');
                    loadComments(postId);
                } else {
                    commentSection.classList.add('hidden');
                }
            });
        });

        // Load comments
        function loadComments(postId) {
            const commentsContainer = document.getElementById(`comments-container-${postId}`);
            fetch(`/get-comments/${postId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    commentsContainer.innerHTML = '';
                    if (data.comments.length > 0) {
                        data.comments.forEach(comment => {
                            addCommentToDOM(commentsContainer, comment);
                        });
                    } else {
                        commentsContainer.innerHTML = '<p class="text-gray-500 text-center py-3">Chưa có bình luận nào.</p>';
                    }
                } else {
                    alert(data.error || 'Có lỗi xảy ra khi tải bình luận.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi tải bình luận: ' + error.message);
            });
        }

        // Add comment to DOM
        function addCommentToDOM(container, comment) {
            const template = document.getElementById('comment-template');
            const clone = document.importNode(template.content, true);
            clone.querySelector('.comment-username').textContent = comment.username;
            clone.querySelector('.comment-time').textContent = comment.created_at;
            clone.querySelector('.comment-content').textContent = comment.content;
            clone.querySelector('img').src = comment.avatar_url || '{% static "image/avt.png" %}';
            container.appendChild(clone);
        }

        // Send comment
        const commentInputs = document.querySelectorAll('.comment-input');
        commentInputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const postId = this.getAttribute('data-post-id');
                    const content = this.value.trim();
                    if (!content) {
                        alert('Vui lòng nhập nội dung bình luận!');
                        return;
                    }
                    sendComment(postId, content, this);
                }
            });
        });

        const sendCommentBtns = document.querySelectorAll('.send-comment-btn');
        sendCommentBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const postId = this.getAttribute('data-post-id');
                const input = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
                const content = input.value.trim();
                if (!content) {
                    alert('Vui lòng nhập nội dung bình luận!');
                    return;
                }
                sendComment(postId, content, input);
            });
        });

        // Send comment to server
        function sendComment(postId, content, input) {
            const formData = new FormData();
            formData.append('content', content);
            fetch(`/add-comment/${postId}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Yêu cầu không thành công: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    input.value = '';
                    const commentsContainer = document.getElementById(`comments-container-${postId}`);
                    const noComments = commentsContainer.querySelector('p.text-gray-500');
                    if (noComments) {
                        noComments.remove();
                    }
                    data.avatar_url = '{% if nguoi_dung.avatar %}{{ nguoi_dung.avatar.url }}{% else %}{% static "image/avt.png" %}{% endif %}';
                    addCommentToDOM(commentsContainer, data);
                    const commentBtn = document.querySelector(`.comment-btn[data-post-id="${postId}"]`);
                    const commentCount = commentBtn.querySelector('.comment-count');
                    commentCount.textContent = parseInt(commentCount.textContent) + 1;
                } else {
                    alert(data.error || 'Có lỗi xảy ra khi gửi bình luận.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi gửi bình luận: ' + error.message);
            });
        }

        // Vote poll
        const voteCheckboxes = document.querySelectorAll('.vote-checkbox');
        voteCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const postId = this.getAttribute('data-post-id');
                const optionId = this.getAttribute('data-option-id');
                const pollContainer = this.closest('.poll-container');
                const isChecked = this.checked;

                fetch(`/vote-poll/${postId}/${optionId}/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Yêu cầu không thành công: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const totalVotes = data.total_votes;
                        const votesData = data.votes;

                        const options = pollContainer.querySelectorAll('.vote-option-container');
                        options.forEach(option => {
                            const optId = option.querySelector('.vote-checkbox').getAttribute('data-option-id');
                            const votes = votesData[optId] || 0;

                            const voteTextContainer = option.closest('.mb-2').querySelector('.text-xs');
                            if (voteTextContainer) {
                                const voteCountSpan = voteTextContainer.querySelector('.vote-count');
                                if (voteCountSpan) {
                                    voteCountSpan.textContent = votes;
                                }

                                const votersBtn = voteTextContainer.querySelector('.voters-btn');
                                if (votersBtn && votes === 0) {
                                    votersBtn.remove();
                                } else if (!votersBtn && votes > 0) {
                                    voteTextContainer.insertAdjacentHTML('beforeend',
                                        `<button class="voters-btn text-blue-500 ml-2" data-option-id="${optId}">Xem danh sách</button>`);
                                    const newVotersBtn = voteTextContainer.querySelector('.voters-btn');
                                    newVotersBtn.addEventListener('click', loadVoters);
                                }
                            }
                        });
                    } else {
                        this.checked = !isChecked;
                        alert(data.error || 'Có lỗi xảy ra khi bình chọn.');
                    }
                })
                .catch(error => {
                    this.checked = !isChecked;
                    console.error('Fetch error:', error);
                    alert('Có lỗi xảy ra khi bình chọn: ' + error.message);
                });
            });
        });

        // Load voters list for poll option
        function loadVoters() {
            const optionId = this.getAttribute('data-option-id');
            const votersList = document.querySelector(`.voters-list[data-option-id="${optionId}"]`);
            if (votersList.classList.contains('hidden')) {
                fetch(`/get-voters/${optionId}/`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        votersList.innerHTML = data.voters.length > 0 ? data.voters.join(', ') : 'Chưa có người bầu chọn.';
                        votersList.classList.remove('hidden');
                    } else {
                        alert(data.error || 'Có lỗi xảy ra khi tải danh sách người bầu chọn.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi tải danh sách người bầu chọn: ' + error.message);
                });
            } else {
                votersList.classList.add('hidden');
            }
        }

        // Attach event listeners to existing voters buttons
        const votersBtns = document.querySelectorAll('.voters-btn');
        votersBtns.forEach(btn => btn.addEventListener('click', loadVoters));

        // Approve group
        window.approveGroup = function(groupId) {
            if (confirm('Bạn có chắc chắn muốn phê duyệt nhóm này?')) {
                fetch(`/GV/nhom_admin/api/groups/${groupId}/approve/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Nhóm đã được phê duyệt thành công!');
                        location.reload();
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Đã xảy ra lỗi khi phê duyệt nhóm.');
                });
            }
        };

        // Reject group
        window.rejectGroup = function(groupId) {
            if (confirm('Bạn có chắc chắn muốn từ chối nhóm này?')) {
                fetch(`/GV/nhom_admin/api/groups/${groupId}/reject/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Nhóm đã bị từ chối thành công!');
                        location.reload();
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Đã xảy ra lỗi khi từ chối nhóm.');
                });
            }
        };

        // Open group approval modal
        window.openGroupApprovalModal = function(groupId, groupName, groupDescription) {
            currentGroupId = groupId;
            groupNameElement.textContent = groupName;
            groupDescriptionElement.textContent = groupDescription;
            groupApprovalModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        // Close group approval modal
        closeApprovalModalBtn.addEventListener('click', function() {
            groupApprovalModal.classList.add('hidden');
            document.body.style.overflow = '';
            currentGroupId = null;
        });

        // Close group approval modal when clicking outside
        groupApprovalModal.addEventListener('click', function(e) {
            if (e.target === groupApprovalModal) {
                groupApprovalModal.classList.add('hidden');
                document.body.style.overflow = '';
                currentGroupId = null;
            }
        });

        // Approve group from modal
        approveGroupBtn.addEventListener('click', function() {
            if (currentGroupId) {
                approveGroup(currentGroupId);
            }
        });

        // Reject group from modal
        rejectGroupBtn.addEventListener('click', function() {
            if (currentGroupId) {
                rejectGroup(currentGroupId);
            }
        });

        // Delete group
        window.confirmDeleteGroup = function(groupId) {
            if (confirm('Bạn có chắc chắn muốn xóa nhóm này?')) {
                fetch(`/GV/nhom_admin/api/delete_group/${groupId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Nhóm đã được xóa thành công!');
                        location.reload();
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Đã xảy ra lỗi khi xóa nhóm.');
                });
            }
        };

        // Open modal
        createGroupBtn.addEventListener('click', function() {
            createGroupModal.classList.remove('hidden');
        });

        // Close modal
        closeModalBtn.addEventListener('click', function() {
            createGroupModal.classList.add('hidden');
        });

        // Close modal when clicking outside
        createGroupModal.addEventListener('click', function(e) {
            if (e.target === createGroupModal) {
                createGroupModal.classList.add('hidden');
            }
        });

        // Handle form submission
        createGroupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(createGroupForm);

            fetch(createGroupForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Lỗi HTTP: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message || 'Nhóm đã được tạo thành công!');
                    createGroupModal.classList.add('hidden');
                    location.reload();
                } else {
                    let errorMessage = data.message || 'Đã xảy ra lỗi khi tạo nhóm.';
                    if (data.errors) {
                        try {
                            const errors = JSON.parse(data.errors);
                            errorMessage += '\nChi tiết lỗi:\n';
                            for (let field in errors) {
                                errors[field].forEach(error => {
                                    errorMessage += `- ${field}: ${error.message}\n`;
                                });
                            }
                        } catch (e) {
                            errorMessage += '\nLỗi khi xử lý thông tin lỗi từ server.';
                        }
                    }
                    alert(errorMessage);
                }
            })
            .catch(error => {
                console.error('Lỗi khi gửi yêu cầu:', error);
                alert('Đã xảy ra lỗi khi tạo nhóm: ' + error.message);
            });
        });

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}