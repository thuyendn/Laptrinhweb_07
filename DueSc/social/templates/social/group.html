{% extends 'base.html' %}
{% load static %}

{% block title %}Nhóm - DUE Social{% endblock %}

{% block content %}
<div class="flex justify-center mx-auto ml-10">
    <div class="flex justify-center mx-auto">
        <div class="w-full absolute lg:w-3/5 xl:w-2/4 px-10">
            {% block content_body %}
            {% endblock %}

            {% block post %}
            {% for item in posts_with_wordcount %}
            <div class="post border rounded-lg p-4 mb-4 bg-white shadow-md" data-post-id="{{ item.post.MaBaiViet }}">
                <!-- Avatar và thông tin người đăng -->
                <div class="flex items-center mb-2">
                    <img src="{% if item.post.MaNguoiDung.avatar %}{{ item.post.MaNguoiDung.avatar.url }}{% else %}/static/default-avatar.png{% endif %}" alt="avatar" class="w-10 h-10 rounded-full mr-2">
                    <div>
                        <p class="font-bold">{{ item.post.MaNguoiDung.ho_ten }}</p>
                        <p class="text-gray-500 text-sm">{{ item.post.ThoiGianDang|date:"d/m/Y H:i" }}</p>
                        {% if item.post.MaNhom %}
                            <p class="text-gray-500 text-sm">Trong nhóm: {{ item.post.MaNhom.ten_nhom }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Nội dung bài viết -->
                <div class="relative">
                    <p class="post-content">{{ item.post.NoiDung }}</p>
                    {% if item.word_count > 100 %}
                        <button class="toggle-content-btn" onclick="toggleContent(this)">Xem thêm</button>
                    {% endif %}
                </div>

                <!-- Nút thích và bình luận -->
                <div class="flex justify-between mt-3">
                    <button class="text-gray-500 hover:underline" onclick="likePost(this)">
                        <i class="fas fa-heart text-gray-500 mr-2"></i>
                        <span>{{ item.post.SoLuongCamXuc }} Thích</span>
                    </button>
                    <button class="text-gray-500 hover:underline" onclick="toggleCommentBox(this)">
                        <i class="fas fa-comment text-gray-500 mr-2"></i>
                        <span>Bình luận</span>
                    </button>
                </div>

                <!-- Phần bình luận -->
                <div class="comment-box hidden mt-4">
                    <!-- Bình luận đã có -->
                    <div class="existing-comments space-y-3">
                        {% for comment in item.post.binh_luan.all %}
                        <div class="flex items-start">
                            <img src="{% if comment.MaNguoiDung.avatar %}{{ comment.MaNguoiDung.avatar.url }}{% else %}/static/default-avatar.png{% endif %}" alt="avatar" class="w-8 h-8 rounded-full mr-2">
                            <div>
                                <p class="font-semibold">{{ comment.MaNguoiDung.ho_ten }}</p>
                                <p class="bg-gray-100 rounded-lg p-2">{{ comment.NoiDung }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Gửi bình luận mới -->
                    <div class="flex items-center mt-4">
                        <img src="{% if nguoi_dung.avatar %}{{ nguoi_dung.avatar.url }}{% else %}/static/default-avatar.png{% endif %}" alt="avatar" class="w-8 h-8 rounded-full mr-2">
                        <form action="{% url 'them_binh_luan' item.post.MaBaiViet %}" method="POST" onsubmit="return submitComment(event, this)">
                            {% csrf_token %}
                            <div class="flex items-center space-x-2">
                                <input type="text" name="noi_dung" placeholder="Viết bình luận..." class="border rounded-lg p-2 w-full" required>
                                <button type="submit" class="bg-blue-500 text-white px-3 py-2 rounded-lg">Gửi</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500">Hiện chưa có bài viết nào từ các nhóm bạn tham gia.</p>
            {% endfor %}
            {% endblock %}
        </div>
    </div>
</div>

<style>
    .post-content {
        overflow: hidden;
        max-height: 6rem;
        transition: max-height 0.3s ease-in-out;
        white-space: pre-wrap;
    }

    .toggle-content-btn {
        color: #3b82f6;
        margin-top: 0.25rem;
        font-size: 0.875rem;
    }

    .toggle-content-btn:hover {
        text-decoration: underline;
    }
</style>

<script>
    function toggleContent(button) {
        const content = button.previousElementSibling;
        if (!content) {
            console.error("Không tìm thấy nội dung bài viết để mở rộng!");
            return;
        }

        const isCollapsed = content.style.maxHeight === '6rem' || content.style.maxHeight === '';
        if (isCollapsed) {
            content.style.maxHeight = `${content.scrollHeight}px`; // Mở rộng
            button.textContent = 'Thu gọn';
        } else {
            content.style.maxHeight = '6rem'; // Thu gọn
            button.textContent = 'Xem thêm';
        }
    }

    function toggleCommentBox(button) {
        const post = button.closest('.post');
        const commentBox = post.querySelector('.comment-box');
        commentBox.classList.toggle('hidden');
    }

    function submitComment(event, form) {
        event.preventDefault();
        const formData = new FormData(form);
        const postId = form.closest('.post').dataset.postId;

        fetch(`/binh-luan/${postId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const commentsDiv = form.closest('.comment-box').querySelector('.existing-comments');
                const newComment = document.createElement('div');
                newComment.className = 'flex items-start';
                newComment.innerHTML = `
                    <img src="/static/default-avatar.png" alt="avatar" class="w-8 h-8 rounded-full mr-2">
                    <div>
                        <p class="font-semibold">${data.ho_ten}</p>
                        <p class="bg-gray-100 rounded-lg p-2">${data.noi_dung}</p>
                    </div>
                `;
                commentsDiv.appendChild(newComment);
                form.querySelector('input[name="noi_dung"]').value = '';
            } else {
                alert('Có lỗi khi gửi bình luận: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));

        return false;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

{% endblock %}

{% block group_sidebar %}
<div class="flex justify-between">
    <!-- Cột bên trái (nội dung khác) -->
    <div id="contentLeft" class="w-3/4 p-6">
        <!-- Nội dung chính của bạn nằm ở đây -->
    </div>

    <!-- Cột phải: Danh sách nhóm -->
    <div id="contentRight" class="w-1/4 absolute top-0 right-0 p-6 space-y-6 z-10">
        <!-- Đặt độ rộng lớn hơn cho nhóm -->
        <div class="bg-white p-4 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-gray-800">Nhóm của bạn</h2>
            <div class="mt-4">
                <form method="GET" action="{% url 'search_groups' %}">
                    <input type="text" name="search" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Tìm kiếm nhóm" value="{{ request.GET.search }}">
                    <button type="submit" class="hidden"></button> <!-- Nút ẩn để submit form -->
                </form>
            </div>
            <div class="mt-4">
                <button id="openModal" class="inline-flex items-center bg-green-400 text-black font-semibold py-2 px-4 rounded-lg hover:bg-green-500">
                    <span class="text-2xl mr-2">+</span> Tạo nhóm mới
                </button>
            </div>
        </div>

        <!-- Các nhóm đã tham gia -->
        <div class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-800">Nhóm bạn đã tham gia</h3>
            <div class="mt-4 space-y-4">
                {% for tv in nhom_da_tham_gia|slice:":2" %}
                <div class="flex items-center space-x-4">
                    <img src="{% static 'image/Nhom/nhom1.png' %}" alt="Group" class="rounded-full w-12 h-12">
                    <span class="text-lg">{{ tv.ma_nhom.ten_nhom }}</span>
                </div>
                {% empty %}
                <p class="text-gray-500">Bạn chưa tham gia nhóm nào.</p>
                {% endfor %}
            </div>
            <a href="{% url 'nhom_da_tham_gia' %}" class="text-blue-600 hover:underline mt-4 inline-block">Xem thêm</a>
        </div>

        <!-- Các nhóm làm quản trị viên -->
        <div class="bg-white p-4 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-gray-800">Nhóm bạn làm quản trị viên</h2>
            <div class="mt-4 space-y-4">
                {% for tv in nhom_lam_qtrivien|slice:":2" %}
                <div class="flex items-center space-x-4">
                    <img src="{% static 'image/Nhom/nhom1.png' %}" alt="Nhóm quản trị" class="rounded-full w-12 h-12">
                    <span class="text-lg">{{ tv.ma_nhom.ten_nhom }}</span>
                </div>
                {% empty %}
                <p class="text-gray-500">Bạn chưa làm quản trị viên nhóm nào.</p>
                {% endfor %}
            </div>
            <a href="{% url 'nhom_lam_qtrivien' %}" class="text-blue-600 hover:underline mt-4 inline-block">Xem thêm</a>
        </div>
    </div>
</div>

<!-- Modal tạo nhóm mới -->
<div id="createGroupModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-1/3 max-h-screen flex flex-col">
        <div class="modal-header flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Tạo nhóm</h2>
            <button id="closeCreateModal" class="text-gray-500 hover:bg-gray-100 p-1 rounded-full">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="createGroupForm" method="POST" action="{% url 'tao_nhom_moi' %}">
            {% csrf_token %}
            <div class="member flex items-center mb-4">
                <img src="{% if nguoi_dung.avatar %}{{ nguoi_dung.avatar.url }}{% else %}/static/default-avatar.png{% endif %}" alt="Avatar" class="w-10 h-10 rounded-full mr-2">
                <div>
                    <p class="font-semibold">{{ nguoi_dung.ho_ten }}</p>
                    <p class="text-gray-500 text-sm">Quản trị viên</p>
                </div>
            </div>
            <div class="mb-4">
                <label for="groupName" class="block text-gray-700 font-semibold mb-2">Tên Nhóm</label>
                <input type="text" id="groupName" name="group_name" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="Tên Nhóm" required>
            </div>
            <div class="mb-4">
                <label for="groupDesc" class="block text-gray-700 font-semibold mb-2">Mô tả nhóm</label>
                <textarea id="groupDesc" name="group_description" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="Mô tả nhóm" rows="5"></textarea>
            </div>
            <button type="submit" class="w-full bg-green-400 text-black font-semibold py-3 px-4 rounded-lg hover:bg-green-500">Gửi yêu cầu tạo nhóm</button>
        </form>
    </div>
</div>

<!-- JavaScript để mở và đóng modal tạo nhóm -->
<script>
   const openModalButton = document.getElementById('openModal');
   const createGroupModal = document.getElementById('createGroupModal');
   const closeCreateModalButton = document.getElementById('closeCreateModal');

   openModalButton.addEventListener('click', function() {
       createGroupModal.classList.remove('hidden');
   });

   closeCreateModalButton.addEventListener('click', function() {
       createGroupModal.classList.add('hidden');
   });

   window.addEventListener('click', function(event) {
       if (event.target === createGroupModal) {
           createGroupModal.classList.add('hidden');
       }
   });
</script>

<!-- JavaScript likePost và getCookie -->
<script>
function likePost(button) {
    const postId = button.closest('.post').dataset.postId;
    fetch(`/like-post/${postId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        const span = button.querySelector('span');
        span.innerText = `${data.SoLuongCamXuc} Thích`;
        const heartIcon = button.querySelector('i');
        if (data.liked) {
            heartIcon.classList.remove('text-gray-500');
            heartIcon.classList.add('text-red-500');
        } else {
            heartIcon.classList.remove('text-red-500');
            heartIcon.classList.add('text-gray-500');
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}