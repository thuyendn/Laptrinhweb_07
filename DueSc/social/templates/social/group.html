{% extends 'base.html' %}
{% load static %}

{% block title %}Nhóm - DUE Social{% endblock %}

{% block content %}
<div class="flex justify-center mx-auto ml-10">
    <div class="flex justify-center mx-auto">
        <div class="w-full absolute lg:w-3/5 xl:w-2/4 px-10">

            {% block content_body %}
            {% endblock %}

            {% block post %}
            <!-- Danh sách bài viết -->
            {% for item in posts_with_wordcount %}
            <div class="post border rounded-lg p-4 mb-4 bg-white shadow-md">
                <!-- Avatar và thông tin người đăng -->
                <div class="flex items-center mb-2">
                    <img src="/static/default-avatar.png" alt="avatar" class="w-10 h-10 rounded-full mr-2">
                    <div>
                        <p class="font-bold">{{ item.post.ma_nguoi_dung.ho_ten }}</p>
                        <p class="text-gray-500 text-sm">{{ item.post.ThoiGianDang|date:"d/m/Y H:i" }}</p>
                    </div>
                </div>

                <!-- Nội dung bài viết -->
                <div class="relative">
                    <p class="post-content overflow-hidden max-h-24 transition-all duration-300 ease-in-out">{{ item.post.NoiDung }}</p>
                    {% if item.word_count > 100 %} <!-- Giả định giới hạn 100 từ -->
                        <button class="text-blue-500 mt-1 text-sm" onclick="toggleContent(this)">Xem thêm</button>
                    {% endif %}
                </div>

                <!-- Nút thích và bình luận -->
                <div class="flex justify-between mt-2">
                    <button class="text-gray-500 hover:underline">
                        <i class="fas fa-heart text-red-500 mr-2"></i>
                        <span>Thích</span>
                    </button>
                    <button class="text-gray-500 hover:underline" onclick="toggleCommentBox(this)">
                        <i class="fas fa-comment text-gray-500 mr-2"></i>
                        <span>Bình luận</span>
                    </button>
                </div>

                <!-- Khung bình luận (ẩn ban đầu) -->
                <div class="comment-box hidden mt-4">
                    <!-- Hiển thị các bình luận (giả định có quan hệ với BaiViet) -->
                    {% for comment in item.post.binh_luan_set.all %}
                    <div class="flex items-start mb-2">
                        <img src="/static/default-avatar.png" alt="avatar" class="w-8 h-8 rounded-full mr-2">
                        <div>
                            <p class="text-sm font-semibold">{{ comment.MaNguoiDung.ho_ten }}</p>
                            <p class="text-gray-600 text-sm">{{ comment.NoiDung }}</p>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Form nhập bình luận -->
                    <div class="flex items-center mt-2">
                        <img src="/static/default-avatar.png" alt="avatar" class="w-8 h-8 rounded-full mr-2">
                        <input type="text" placeholder="Viết bình luận..." class="border rounded-lg p-2 w-full" id="comment-input-{{ item.post.MaBaiViet }}">
                        <button class="bg-blue-500 text-white px-3 py-2 rounded-lg ml-2" onclick="submitComment({{ item.post.MaBaiViet }})">Gửi</button>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-center text-gray-500">Không có bài viết nào để hiển thị.</p>
            {% endfor %}
            {% endblock %}
        </div>
    </div>
</div>

{% endblock %}

{% block group_sidebar %}
<div class="flex justify-between">
    <!-- Cột bên trái (nội dung khác) -->
    <div id="contentLeft" class="w-3/4 p-6">
        <!-- Nội dung chính của bạn nằm ở đây -->
    </div>

    <!-- Cột phải: Danh sách nhóm -->
    <div id="contentRight" class="w-1/4 absolute top-0 right-0 p-6 space-y-6 z-10">
        <!-- Đặt độ rộng lớn hơn cho nhóm -->
        <div class="bg-white p-4 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-gray-800">Nhóm của bạn</h2>
            <div class="mt-4">
                <form method="GET" action="{% url 'ket_qua_tim_kiem_nhom' %}">
                    <input type="text" name="search" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Tìm kiếm nhóm" value="{{ request.GET.search }}">
                    <button type="submit" class="hidden"></button> <!-- Nút ẩn để submit form -->
                </form>
            </div>
            <div class="mt-4">
                <button id="openModal" class="inline-flex items-center bg-green-400 text-black font-semibold py-2 px-4 rounded-lg hover:bg-green-500">
                    <span class="text-2xl mr-2">+</span> Tạo nhóm mới
                </button>
            </div>
        </div>

        <!-- Các nhóm đã tham gia -->
        <div class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-800">Nhóm bạn đã tham gia</h3>
            <div class="mt-4 space-y-4">
                {% for tv in nhom_da_tham_gia %}
                <div class="flex items-center space-x-4">
                    <img src="https://via.placeholder.com/50" alt="Group" class="rounded-full w-12 h-12">
                    <span class="text-lg">{{ tv.ma_nhom.TenNhom }}</span>
                </div>
                {% empty %}
                <p class="text-gray-500">Bạn chưa tham gia nhóm nào.</p>
                {% endfor %}
            </div>
            <a href="{% url 'nhom_da_tham_gia' %}" class="text-blue-600 hover:underline mt-4 inline-block">Xem thêm</a>
        </div>

        <!-- Các nhóm làm quản trị viên -->
        <div class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-800">Nhóm bạn làm quản trị viên</h3>
            <div class="mt-4 space-y-4">
                {% for tv in nhom_lam_qtrivien %}
                <div class="flex items-center space-x-4">
                    <img src="https://via.placeholder.com/50" alt="Admin Group" class="rounded-full w-12 h-12">
                    <span class="text-lg">{{ tv.ma_nhom.TenNhom }}</span>
                </div>
                {% empty %}
                <p class="text-gray-500">Bạn chưa quản trị nhóm nào.</p>
                {% endfor %}
            </div>
            <a href="{% url 'nhom_lam_qtrivien' %}" class="text-blue-600 hover:underline mt-4 inline-block">Xem thêm</a>
        </div>
    </div>
</div>
<!-- Modal tạo nhóm mới -->
<div id="createGroupModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-1/3 max-h-screen flex flex-col">
        <div class="modal-header flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Tạo nhóm</h2>
            <button id="closeCreateModal" class="text-gray-500 hover:bg-gray-100 p-1 rounded-full">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="createGroupForm" method="POST" action="{% url 'tao_nhom_moi' %}">
            {% csrf_token %}
            <div class="member flex items-center mb-4">
                <img src="{% if nguoi_dung.avatar %}{{ nguoi_dung.avatar.url }}{% else %}/static/default-avatar.png{% endif %}" alt="Avatar" class="w-10 h-10 rounded-full mr-2">
                <div>
                    <p class="font-semibold">{{ nguoi_dung.ho_ten }}</p>
                    <p class="text-gray-500 text-sm">Quản trị viên</p>
                </div>
            </div>
            <div class="mb-4">
                <label for="groupName" class="block text-gray-700 font-semibold mb-2">Tên Nhóm</label>
                <input type="text" id="groupName" name="group_name" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="Tên Nhóm" required>
            </div>
            <div class="mb-4">
                <label for="groupDesc" class="block text-gray-700 font-semibold mb-2">Mô tả nhóm</label>
                <textarea id="groupDesc" name="group_description" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="Mô tả nhóm" rows="5"></textarea>
            </div>
            <button type="submit" class="w-full bg-green-400 text-black font-semibold py-3 px-4 rounded-lg hover:bg-green-500">Gửi yêu cầu tạo nhóm</button>
        </form>
    </div>
</div>
{% endblock %}

<script>
function toggleContent(button) {
    const content = button.previousElementSibling;
    const isCollapsed = content.classList.contains('max-h-24');

    if (isCollapsed) {
        content.classList.remove('max-h-24');
        button.innerText = 'Thu gọn';
    } else {
        content.classList.add('max-h-24');
        button.innerText = 'Xem thêm';
    }
}

function toggleCommentBox(button) {
    const commentBox = button.closest('.post').querySelector('.comment-box');
    commentBox.classList.toggle('hidden');
}

function submitComment(postId) {
    const commentInput = document.getElementById(`comment-input-${postId}`);
    const commentText = commentInput.value.trim();
    if (commentText) {
        // Gửi AJAX request để lưu bình luận (giả định)
        fetch('/them-binh-luan/' + postId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `noi_dung=${encodeURIComponent(commentText)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const commentBox = document.querySelector(`#comment-input-${postId}`).closest('.comment-box');
                const newComment = document.createElement('div');
                newComment.className = 'flex items-start mb-2';
                newComment.innerHTML = `
                    <img src="/static/default-avatar.png" alt="avatar" class="w-8 h-8 rounded-full mr-2">
                    <div>
                        <p class="text-sm font-semibold">{{ nguoi_dung.ho_ten }}</p>
                        <p class="text-gray-600 text-sm">${commentText}</p>
                    </div>
                `;
                commentBox.querySelector('.existing-comments').prepend(newComment);
                commentInput.value = '';
            } else {
                alert('Lỗi khi gửi bình luận: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }
}
    <!-- Modal tạo nhóm mới -->
<div id="createGroupModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-1/3 max-h-screen flex flex-col">
        <div class="modal-header flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Tạo nhóm</h2>
            <button id="closeCreateModal" class="text-gray-500 hover:bg-gray-100 p-1 rounded-full">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="createGroupForm" method="POST" action="{% url 'tao_nhom_moi' %}">
            {% csrf_token %}
            <div class="member flex items-center mb-4">
                <img src="{% if nguoi_dung.avatar %}{{ nguoi_dung.avatar.url }}{% else %}/static/default-avatar.png{% endif %}" alt="Avatar" class="w-10 h-10 rounded-full mr-2">
                <div>
                    <p class="font-semibold">{{ nguoi_dung.ho_ten }}</p>
                    <p class="text-gray-500 text-sm">Quản trị viên</p>
                </div>
            </div>
            <div class="mb-4">
                <label for="groupName" class="block text-gray-700 font-semibold mb-2">Tên Nhóm</label>
                <input type="text" id="groupName" name="group_name" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="Tên Nhóm" required>
            </div>
            <div class="mb-4">
                <label for="groupDesc" class="block text-gray-700 font-semibold mb-2">Mô tả nhóm</label>
                <textarea id="groupDesc" name="group_description" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="Mô tả nhóm" rows="5"></textarea>
            </div>
            <button type="submit" class="w-full bg-green-400 text-black font-semibold py-3 px-4 rounded-lg hover:bg-green-500">Gửi yêu cầu tạo nhóm</button>
        </form>
    </div>
</div>

<!-- JavaScript để mở và đóng modal tạo nhóm -->
<script>
   const openModalButton = document.getElementById('openModal');
   const createGroupModal = document.getElementById('createGroupModal');
   const closeCreateModalButton = document.getElementById('closeCreateModal');

   openModalButton.addEventListener('click', function() {
       createGroupModal.classList.remove('hidden');
   });

   closeCreateModalButton.addEventListener('click', function() {
       createGroupModal.classList.add('hidden');
   });

   window.addEventListener('click', function(event) {
       if (event.target === createGroupModal) {
           createGroupModal.classList.add('hidden');
       }
   });
</script>